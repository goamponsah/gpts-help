<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPTs Help ‚Äì Master Math with AI</title>
  <style>
    :root {
      --brand:#6f42c1;   /* Purple */
      --accent:#ffc107;  /* Amber */
      --bg:#f8f9fa;
      --text:#212529;
      --muted:#6c757d;
      --panel:#fff;
      --border:#eee;
      --shadow:0 16px 36px rgba(0,0,0,.08);
      --error:#dc3545;
      --ok:#198754;
      --ink:#0f1117;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;color:var(--text);background:var(--bg)}
    a{color:var(--brand);text-decoration:none}

    /* Header */
    header{background:#fff;border-bottom:1px solid #eee}
    .nav{max-width:1200px;margin:0 auto;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:800;letter-spacing:.2px}
    .nav-right{display:flex;gap:.5rem;align-items:center}
    .btn-nav{border:1px solid var(--border);background:#fff;color:var(--brand);padding:.55rem .9rem;border-radius:10px;cursor:pointer;font-weight:600}
    .btn-nav.primary{background:var(--brand);color:#fff;border-color:transparent}

    /* Hero */
    .hero{background:linear-gradient(135deg, var(--brand), #9c6fff);color:#fff;text-align:center;padding:5rem 2rem}
    .hero h1{font-size:clamp(2rem,4vw,3rem);margin-bottom:1rem}
    .hero p{font-size:1.1rem;max-width:820px;margin:0 auto 1.25rem;opacity:.98}
    .hero-cta{display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap}
    .btn{padding:.85rem 1.2rem;font-weight:700;border:none;border-radius:10px;cursor:pointer}
    .btn-primary{background:var(--accent);color:#000}
    .btn-secondary{background:#fff;color:var(--brand);border:1px solid var(--border)}

    /* Sections */
    .container{max-width:1200px;margin:0 auto;padding:2rem}
    h2{margin:.5rem 0}

    /* ‚ÄúSee it solve a photo‚Äù */
    .demo{display:grid;grid-template-columns:1.2fr 1fr;gap:1.5rem;margin-top:1.5rem}
    .demo-card{background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .demo-input{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-top:.5rem}
    .pill{display:inline-flex;gap:.4rem;align-items:center;background:#f1ecff;color:#3c2a75;border:1px solid #e3dcff;padding:.35rem .6rem;border-radius:999px;font-size:.85rem;font-weight:600}
    .upload-btn{border:1px dashed #c9b7ff;background:#faf8ff;color:#3c2a75;font-weight:700;border-radius:10px;padding:.7rem 1rem;cursor:pointer}
    .demo-hint{color:var(--muted);font-size:.9rem;margin-top:.4rem}
    .preview{background:#0e0f13;color:#e7eaf1;border:1px solid #232634;border-radius:12px;padding:14px;min-height:160px;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .preview .ok{color:#8ff0b3}
    .preview .dim{color:#8b93ad}
    .thumb{display:inline-block;max-width:260px;border-radius:10px;border:1px solid #ddd}

    /* Features */
    .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.5rem;margin-top:2rem}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:1.5rem;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
    .check{color:#198754;font-weight:800;margin-right:.3rem}

    /* Social proof bar */
    .proof{display:flex;flex-wrap:wrap;gap:.8rem;align-items:center;margin-top:1rem;color:#2f3640}
    .badge{display:inline-flex;gap:.4rem;align-items:center;background:#fff;border:1px solid #eee;border-radius:999px;padding:.35rem .7rem;font-size:.85rem}
    .star{color:#f8b400}

    /* Pricing */
    .plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-top:2rem}
    .plan{background:#fff;border:1px solid #eee;border-radius:14px;padding:2rem;position:relative;text-align:center;box-shadow:var(--shadow)}
    .plan h3{margin-bottom:.5rem}
    .price{font-size:2rem;color:var(--brand);margin:.5rem 0 1rem}
    .plan ul{list-style:none;padding:0;margin:1rem 0;color:var(--muted);text-align:left}
    .plan li{margin:.35rem 0}
    .plan .key{color:#212433;font-weight:700}
    .plan .limit{color:#9a7cff;font-weight:700}
    .badge-right{position:absolute;top:12px;right:12px;background:var(--brand);color:#fff;font-size:.75rem;padding:.25rem .5rem;border-radius:999px}

    /* Testimonials */
    .testimonials{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-top:2rem}
    .testimonial{background:#fff;border:1px solid #eee;border-radius:12px;padding:1.5rem;font-style:italic}

    footer{text-align:center;padding:2rem;color:var(--muted);margin-top:3rem;border-top:1px solid #eee}

    /* Modals */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000}
    .overlay.open{display:flex}
    .modal{width:min(480px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:var(--shadow)}
    .modal h3{margin:.25rem 0 4px;font-size:1.15rem}
    .modal p.sub{color:var(--muted);margin:0 0 12px;font-size:.95rem}
    .row{display:flex;gap:.6rem}
    label{display:block;font-size:.9rem;color:var(--muted);margin:.35rem 0 .35rem}
    input[type="email"],input[type="password"]{width:100%;padding:.75rem .9rem;border:1px solid #ddd;border-radius:10px;font-size:1rem}
    .modal .btn{width:100%}
    .close-x{border:0;background:transparent;color:#999;font-size:20px;cursor:pointer;float:right}
    .err{color:var(--error);font-size:.9rem;min-height:18px;margin-top:6px}
    .muted{color:var(--muted);font-size:.9rem;margin-top:8px}
    .step{display:none}.step.active{display:block}
    .inline{display:flex;align-items:center;gap:.5rem}
    .link{color:var(--brand);background:none;border:0;padding:0;cursor:pointer;font-weight:600}
    .spinner{width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-3px;animation:spin .7s linear infinite;margin-right:.35rem}
    .spinner.dark{border-color:#555;border-right-color:transparent}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="nav">
      <div class="brand">GPTs Help</div>
      <div class="nav-right">
        <button id="openChatBtn" class="btn-nav" style="display:none" onclick="goToChat()">Open Chat</button>
        <button id="loginBtn" class="btn-nav">Log in</button>
        <button id="signupBtn" class="btn-nav primary">Sign up for free</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <h1>Master Math with AI</h1>
    <p>Take a photo of any math problem and get clear, step-by-step solutions with reasoning and worked steps.</p>
    <div class="hero-cta">
      <button class="btn btn-primary" id="heroTryPhoto">üì∑ Try Photo Solve</button>
      <button class="btn btn-secondary" id="heroSignup">Create free account</button>
    </div>
    <div class="proof">
      <span class="badge"><span class="star">‚òÖ</span> Loved by students</span>
      <span class="badge">Algebra ‚Ä¢ Calculus ‚Ä¢ Trig ‚Ä¢ Probability</span>
      <span class="badge">Fast & Private</span>
    </div>
  </section>

  <!-- See it solve a photo -->
  <section class="container">
    <h2>See it solve a photo</h2>
    <div class="demo">
      <div class="demo-card">
        <div class="pill">Photo ‚Üí Steps</div>
        <div class="demo-input">
          <button class="upload-btn" id="demoUploadBtn">Upload a math photo</button>
          <input type="file" id="demoFile" accept="image/png,image/jpeg,image/jpg,image/webp" hidden />
          <span class="demo-hint">Try a clear photo of an equation or word problem (‚â§ 6 MB).</span>
        </div>
        <div style="margin-top:12px;">
          <img id="demoThumb" class="thumb" alt="" style="display:none"/>
        </div>
      </div>

      <div class="demo-card">
        <div class="pill">Solution Preview</div>
        <div id="demoPreview" class="preview">
          <span class="dim">No image yet.</span> Upload a photo to see step-by-step reasoning here.
        </div>
        <div style="margin-top:10px; display:flex; gap:.6rem; flex-wrap:wrap;">
          <button class="btn btn-primary" id="goUnlimitedBtn">Unlock unlimited Photo Solve</button>
          <a href="/chat.html" class="btn btn-secondary" id="openFullChatBtn">Open full chat</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Features -->
  <section class="container">
    <h2>Why Choose GPTs Help?</h2>
    <div class="features">
      <div class="card"><h3>Step-by-Step Solutions</h3><p><span class="check">‚úì</span>Explain every step, not just the final answer.</p></div>
      <div class="card"><h3>Multiple Methods</h3><p><span class="check">‚úì</span>Get alternate approaches and hints.</p></div>
      <div class="card"><h3>LaTeX-Quality Math</h3><p><span class="check">‚úì</span>Crisp, readable formulas and proofs.</p></div>
      <div class="card"><h3>Exam-Ready Practice</h3><p><span class="check">‚úì</span>Drills with instant feedback.</p></div>
    </div>
  </section>

  <!-- Pricing -->
  <section class="container" id="pricing">
    <h2>Choose Your Plan</h2>

    <div class="plans">
      <!-- Free -->
      <div class="plan">
        <h3>Free Plan</h3>
        <div class="price">‚Çµ0 / mo</div>
        <ul>
          <li><span class="limit">10 Photo Solve</span> credits / month</li>
          <li>Basic step-by-step explanations</li>
          <li>Selected worked examples</li>
        </ul>
        <button class="btn btn-secondary" id="startFreeBtn">Start free</button>
      </div>

      <!-- Plus Monthly -->
      <div class="plan">
        <div class="badge-right">Popular</div>
        <h3>Plus Monthly</h3>
        <div class="price">‚Çµ99 / mo</div>
        <ul>
          <li class="key">Unlimited Photo Solve</li>
          <li>Advanced reasoning & proofs</li>
          <li>Full worked-examples library</li>
        </ul>
        <button class="btn btn-primary" id="plusMonthlyBtn">Subscribe Monthly</button>
      </div>

      <!-- Pro Annual -->
      <div class="plan">
        <h3>Pro Annual</h3>
        <div class="price">‚Çµ790 / yr</div>
        <ul>
          <li class="key">Unlimited Photo Solve</li>
          <li>Everything in Plus</li>
          <li>Priority support</li>
        </ul>
        <button class="btn btn-primary" id="proAnnualBtn">Subscribe Annually</button>
      </div>
    </div>
  </section>

  <!-- Testimonials -->
  <section class="container">
    <h2>What Our Users Say</h2>
    <div class="testimonials">
      <div class="testimonial">‚ÄúI snapped my calculus question and got clean steps to the answer in seconds.‚Äù<br><strong>‚Äî Ama A., Student</strong></div>
      <div class="testimonial">‚ÄúThe Photo Solve feature is worth it alone. Unlimited makes revision painless.‚Äù<br><strong>‚Äî Daniel K., Engineering</strong></div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    &copy; <span id="year"></span> GPTs Help. All rights reserved.
  </footer>

  <!-- Log in Modal -->
  <div class="overlay" id="loginOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <button class="close-x" id="loginClose" aria-label="Close">√ó</button>
      <h3 id="loginTitle">Log in to GPTs Help</h3>
      <p class="sub">Use your account email and password.</p>

      <!-- Step 1: Email -->
      <div id="loginStepEmail" class="step active">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" placeholder="you@example.com" autocomplete="email" />
        <div class="err" id="loginEmailErr"></div>
        <button class="btn btn-primary" id="loginEmailContinue" type="button">Continue</button>
        <div class="muted" style="margin-top:10px;">New here? <a href="#" id="loginGoSignup">Create an account</a></div>
      </div>

      <!-- Step 2: Password -->
      <div id="loginStepPassword" class="step">
        <label>Email</label>
        <div class="inline" style="justify-content:space-between;">
          <div class="inline"><span id="loginEmailEcho" style="font-weight:600;"></span></div>
          <button class="link" id="loginChangeEmail" type="button">Change</button>
        </div>

        <label for="loginPassword" style="margin-top:8px;">Password</label>
        <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        <div class="err" id="loginErr"></div>
        <button class="btn btn-primary" id="loginSubmit" type="button">Log in</button>
      </div>
    </div>
  </div>

  <!-- Sign up Modal -->
  <div class="overlay" id="signupOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
      <button class="close-x" id="signupClose" aria-label="Close">√ó</button>
      <h3 id="signupTitle">Create your free account</h3>
      <p class="sub">Start with the free plan. Upgrade anytime.</p>

      <!-- Step 1: Email -->
      <div id="signupStepEmail" class="step active">
        <label for="signupEmail">Email</label>
        <input id="signupEmail" type="email" placeholder="you@example.com" autocomplete="email" />
        <div class="err" id="signupEmailErr"></div>
        <button class="btn btn-primary" id="signupEmailContinue" type="button">Continue</button>
        <div class="muted" style="margin-top:10px;">Already have an account? <a href="#" id="signupGoLogin">Log in</a></div>
      </div>

      <!-- Step 2: Password -->
      <div id="signupStepPassword" class="step">
        <label>Email</label>
        <div class="inline" style="justify-content:space-between;">
          <div class="inline"><span id="signupEmailEcho" style="font-weight:600;"></span></div>
          <button class="link" id="signupChangeEmail" type="button">Change</button>
        </div>

        <label for="signupPassword" style="margin-top:8px;">Password</label>
        <input id="signupPassword" type="password" placeholder="At least 8 characters" autocomplete="new-password" />
        <label for="signupPassword2" style="margin-top:8px;">Confirm password</label>
        <input id="signupPassword2" type="password" placeholder="Re-enter password" autocomplete="new-password" />
        <div class="err" id="signupErr"></div>
        <button class="btn btn-primary" id="signupSubmit" type="button">Create account</button>
      </div>
    </div>
  </div>

  <!-- Paystack -->
  <script src="https://js.paystack.co/v2/inline.js"></script>
  <script>
    const genRef = () => "gptshelp_" + Date.now() + "_" + Math.random().toString(36).slice(2,8);

    // Optional redirect after auth
    const urlParams = new URLSearchParams(location.search);
    const NEXT_URL = urlParams.get("next") || "/chat.html";

    // Plan codes (from your Paystack dashboard)
    const PLAN_CODE_PLUS_MONTHLY = "PLN_t8tii7sryvwsxxf";
    const PLAN_CODE_PRO_ANNUAL  = "PLN_3gkd3qo1pv8rylt";

    let PAYSTACK_PUBLIC_KEY = null;
    async function loadConfig(){
      try{
        const r = await fetch("/api/public-config");
        const cfg = await r.json();
        PAYSTACK_PUBLIC_KEY = cfg.paystackPublicKey || null;
      }catch{}
    }
    loadConfig();

    // API helpers
    async function apiMe(){ try{ return await fetch("/api/me",{credentials:"include"}).then(r=>r.json()); }catch{return{}} }
    async function apiLogin(email, password){
      const r = await fetch("/api/login", { method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include", body:JSON.stringify({email,password})});
      return r.json();
    }
    async function apiSignupFree(email, password){
      const r = await fetch("/api/signup-free", { method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include", body:JSON.stringify({email,password})});
      return r.json();
    }
    async function photoSolve(fd){
      const r = await fetch("/api/photo-solve",{ method:"POST", credentials:"include", body:fd });
      return r.json();
    }

    // Utilities
    function goToChat(){ location.assign("/chat.html"); }
    function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
    function setBtnLoading(btn, loading, label){
      if(!btn) return;
      if(loading){
        btn.disabled = true;
        btn.dataset.prev = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span> ' + (label || btn.textContent || 'Working‚Ä¶');
      }else{
        btn.disabled = false;
        btn.textContent = label || btn.dataset.prev || btn.textContent;
      }
    }
    function authOK(r){ return r && (r.status === "ok" || r.status === "success") && (r.user?.email || r.email); }
    function authEmail(r){ return (r && (r.user?.email || r.email)) || ""; }

    // Header auth state
    async function reflectAuth(){
      const me = await apiMe();
      const openChatBtn = document.getElementById("openChatBtn");
      const loginBtn = document.getElementById("loginBtn");
      const signupBtn = document.getElementById("signupBtn");
      if(me?.status === "ok" && me.user?.email){
        openChatBtn.style.display = "inline-block";
        loginBtn.textContent = "Switch account";
        signupBtn.textContent = "New account";
      }else{
        openChatBtn.style.display = "none";
        loginBtn.textContent = "Log in";
        signupBtn.textContent = "Sign up for free";
      }
    }

    // ===== Modals: Login =====
    const loginOverlay = document.getElementById("loginOverlay");
    const loginBtn = document.getElementById("loginBtn");
    const loginClose = document.getElementById("loginClose");
    const loginStepEmail = document.getElementById("loginStepEmail");
    const loginStepPassword = document.getElementById("loginStepPassword");
    const loginEmail = document.getElementById("loginEmail");
    const loginEmailErr = document.getElementById("loginEmailErr");
    const loginEmailContinue = document.getElementById("loginEmailContinue");
    const loginEmailEcho = document.getElementById("loginEmailEcho");
    const loginChangeEmail = document.getElementById("loginChangeEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginErr = document.getElementById("loginErr");
    const loginSubmit = document.getElementById("loginSubmit");
    const loginGoSignup = document.getElementById("loginGoSignup");

    function openLogin(){
      loginEmailErr.textContent=''; loginErr.textContent='';
      loginOverlay.classList.add("open"); loginOverlay.setAttribute("aria-hidden","false");
      loginStepEmail.classList.add("active"); loginStepPassword.classList.remove("active");
      setTimeout(()=>loginEmail.focus(),20);
    }
    function closeLogin(){ loginOverlay.classList.remove("open"); loginOverlay.setAttribute("aria-hidden","true"); }
    function handleLoginEmailContinue(){
      const e = loginEmail.value.trim();
      loginEmailErr.textContent='';
      if(!isValidEmail(e)){ loginEmailErr.textContent="Enter a valid email."; return; }
      loginEmailEcho.textContent=e;
      loginStepEmail.classList.remove("active");
      loginStepPassword.classList.add("active");
      setTimeout(()=>loginPassword.focus(),20);
    }
    async function handleLoginSubmit(){
      const email = loginEmailEcho.textContent.trim() || loginEmail.value.trim();
      const pw = loginPassword.value;
      if(!isValidEmail(email)){ loginStepPassword.classList.remove("active"); loginStepEmail.classList.add("active"); loginEmailErr.textContent="Enter a valid email."; return; }
      if(!pw){ loginErr.textContent="Enter your password."; return; }
      setBtnLoading(loginSubmit, true, "Log in");
      try{
        const r = await apiLogin(email, pw);
        if(authOK(r)){ localStorage.setItem("userEmail", authEmail(r)); location.replace(NEXT_URL); }
        else { loginErr.textContent = r?.message || "Invalid email or password."; }
      }catch{ loginErr.textContent="Could not log in. Check connection."; }
      finally{ setBtnLoading(loginSubmit, false, "Log in"); }
    }
    loginBtn.addEventListener('click', openLogin);
    loginClose.addEventListener('click', closeLogin);
    loginOverlay.addEventListener('click',(e)=>{ if(e.target===loginOverlay) closeLogin(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==="Escape" && loginOverlay.classList.contains("open")) closeLogin(); });
    loginEmailContinue.addEventListener('click', handleLoginEmailContinue);
    loginEmail.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleLoginEmailContinue(); });
    loginChangeEmail.addEventListener('click', ()=>{ loginStepPassword.classList.remove("active"); loginStepEmail.classList.add("active"); setTimeout(()=>loginEmail.focus(),20); });
    loginSubmit.addEventListener('click', handleLoginSubmit);
    loginPassword.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleLoginSubmit(); });
    loginGoSignup.addEventListener('click',(e)=>{ e.preventDefault(); closeLogin(); openSignup(); });

    // ===== Modals: Signup =====
    const signupOverlay = document.getElementById("signupOverlay");
    const signupBtn = document.getElementById("signupBtn");
    const signupClose = document.getElementById("signupClose");
    const signupStepEmail = document.getElementById("signupStepEmail");
    const signupStepPassword = document.getElementById("signupStepPassword");
    const signupEmail = document.getElementById("signupEmail");
    const signupEmailErr = document.getElementById("signupEmailErr");
    const signupEmailContinue = document.getElementById("signupEmailContinue");
    const signupEmailEcho = document.getElementById("signupEmailEcho");
    const signupChangeEmail = document.getElementById("signupChangeEmail");
    const signupPassword = document.getElementById("signupPassword");
    const signupPassword2 = document.getElementById("signupPassword2");
    const signupErr = document.getElementById("signupErr");
    const signupSubmit = document.getElementById("signupSubmit");
    const signupGoLogin = document.getElementById("signupGoLogin");

    function openSignup(){
      signupEmailErr.textContent=''; signupErr.textContent='';
      signupOverlay.classList.add("open"); signupOverlay.setAttribute("aria-hidden","false");
      signupStepEmail.classList.add("active"); signupStepPassword.classList.remove("active");
      setTimeout(()=>signupEmail.focus(),20);
    }
    function closeSignup(){ signupOverlay.classList.remove("open"); signupOverlay.setAttribute("aria-hidden","true"); }
    function handleSignupEmailContinue(){
      const e = signupEmail.value.trim();
      signupEmailErr.textContent='';
      if(!isValidEmail(e)){ signupEmailErr.textContent="Enter a valid email."; return; }
      signupEmailEcho.textContent = e;
      signupStepEmail.classList.remove("active");
      signupStepPassword.classList.add("active");
      setTimeout(()=>signupPassword.focus(),20);
    }
    function passwordOk(p){ return typeof p === 'string' && p.length >= 8; }
    async function handleSignupSubmit(){
      signupErr.textContent='';
      const email = signupEmailEcho.textContent.trim() || signupEmail.value.trim();
      const p1 = signupPassword.value;
      const p2 = signupPassword2.value;
      if(!isValidEmail(email)){ signupStepPassword.classList.remove("active"); signupStepEmail.classList.add("active"); signupEmailErr.textContent="Enter a valid email."; return; }
      if(!passwordOk(p1)){ signupErr.textContent="Password must be at least 8 characters."; return; }
      if(p1!==p2){ signupErr.textContent="Passwords do not match."; return; }
      setBtnLoading(signupSubmit,true,"Create account");
      try{
        const r = await apiSignupFree(email, p1);
        if(authOK(r)){ localStorage.setItem("userEmail", authEmail(r)); location.replace(NEXT_URL); }
        else { signupErr.textContent = r?.message || "Sign up failed. Try again."; }
      }catch{ signupErr.textContent="Network error. Please try again."; }
      finally{ setBtnLoading(signupSubmit,false,"Create account"); }
    }
    signupBtn.addEventListener('click', openSignup);
    signupClose.addEventListener('click', closeSignup);
    signupOverlay.addEventListener('click',(e)=>{ if(e.target===signupOverlay) closeSignup(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==="Escape" && signupOverlay.classList.contains("open")) closeSignup(); });
    signupEmailContinue.addEventListener('click', handleSignupEmailContinue);
    signupEmail.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleSignupEmailContinue(); });
    signupChangeEmail.addEventListener('click', ()=>{ signupStepPassword.classList.remove("active"); signupStepEmail.classList.add("active"); setTimeout(()=>signupEmail.focus(),20); });
    signupSubmit.addEventListener('click', handleSignupSubmit);
    signupPassword2.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleSignupSubmit(); });
    signupGoLogin.addEventListener('click',(e)=>{ e.preventDefault(); closeSignup(); openLogin(); });

    // Pricing actions
    const startFreeBtn   = document.getElementById("startFreeBtn");
    const plusMonthlyBtn = document.getElementById("plusMonthlyBtn");
    const proAnnualBtn   = document.getElementById("proAnnualBtn");
    let pendingPlan = null; // to resume checkout after auth

    startFreeBtn.addEventListener('click', ()=>{
      apiMe().then(me=>{
        if(me?.status==="ok" && me.user?.email){ location.assign("/chat.html"); }
        else { openSignup(); }
      });
    });

    async function startSubscriptionFlow(planCode, label){
      const me = await apiMe();
      if(!(me?.status==="ok" && me.user?.email)){
        pendingPlan = { planCode, label };
        openLogin();
        return;
      }
      if(!PAYSTACK_PUBLIC_KEY){ alert("Payment key not loaded yet. Please try again."); return; }
      const email = me.user.email;

      const popup = new PaystackPop();
      popup.newTransaction({
        key: PAYSTACK_PUBLIC_KEY,
        email,
        currency: "GHS",
        plan: planCode,
        reference: genRef(),
        callback: (response) => {
          fetch("/api/paystack/verify", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            credentials:"include",
            body: JSON.stringify({ reference: response.reference })
          })
          .then(r=>r.json())
          .then(r=>{
            if(r.status==="success" || r.status==="ok"){
              alert(label + " subscription activated!");
              location.href = "/chat.html";
            }else{
              alert("Verification failed. Ref: " + response.reference);
            }
          })
          .catch(()=> alert("Verification request failed."));
        },
        onCancel: () => alert("Payment cancelled.")
      });
    }

    plusMonthlyBtn.addEventListener('click', ()=>startSubscriptionFlow(PLAN_CODE_PLUS_MONTHLY,"Plus Monthly"));
    proAnnualBtn.addEventListener('click', ()=>startSubscriptionFlow(PLAN_CODE_PRO_ANNUAL,"Pro Annual"));

    // Resume checkout after login if pending
    (function wireLoginResume(){
      const oldHandleLoginSubmit = handleLoginSubmit;
      window.handleLoginSubmit = async function(){
        const before = pendingPlan && {...pendingPlan};
        await oldHandleLoginSubmit();
        if(before){
          const me = await apiMe();
          if(me?.status==="ok" && me.user?.email){
            const { planCode, label } = before; pendingPlan = null;
            startSubscriptionFlow(planCode, label);
          }
        }
      };
      loginSubmit.removeEventListener('click', oldHandleLoginSubmit);
      loginSubmit.addEventListener('click', window.handleLoginSubmit);
      loginPassword.addEventListener('keydown',(e)=>{ if(e.key==='Enter') window.handleLoginSubmit(); });
    })();

    // Homepage demo: photo upload
    const demoUploadBtn = document.getElementById('demoUploadBtn');
    const demoFile      = document.getElementById('demoFile');
    const demoThumb     = document.getElementById('demoThumb');
    const demoPreview   = document.getElementById('demoPreview');
    const heroTryPhoto  = document.getElementById('heroTryPhoto');
    const heroSignup    = document.getElementById('heroSignup');
    const goUnlimitedBtn= document.getElementById('goUnlimitedBtn');

    heroSignup.addEventListener('click', ()=> openSignup());
    heroTryPhoto.addEventListener('click', async ()=>{
      const me = await apiMe();
      if(me?.status==="ok" && me.user?.email){
        demoFile.click();
      }else{
        openSignup();
      }
    });

    demoUploadBtn.addEventListener('click', async ()=>{
      const me = await apiMe();
      if(me?.status==="ok" && me.user?.email){
        demoFile.click();
      }else{
        openSignup();
      }
    });

    goUnlimitedBtn.addEventListener('click', ()=> {
      // Scroll to pricing; highlight Plus
      document.getElementById('pricing').scrollIntoView({ behavior:'smooth' });
    });

    demoFile.addEventListener('change', async ()=>{
      const file = demoFile.files && demoFile.files[0];
      if(!file) return;
      const okTypes=['image/png','image/jpeg','image/jpg','image/webp'];
      if(!okTypes.includes(file.type)){ alert('Please choose a PNG, JPG, or WEBP image.'); demoFile.value=''; return; }
      if(file.size>6*1024*1024){ alert('Image is larger than 6MB.'); demoFile.value=''; return; }

      // Show thumb
      const url = URL.createObjectURL(file);
      demoThumb.src = url;
      demoThumb.style.display = 'inline-block';

      // Call photo-solve
      const fd = new FormData();
      fd.append('image', file);
      fd.append('gptType', 'math');
      // short homepage hint:
      fd.append('attempt', 'Please extract the problem and solve step-by-step.');

      demoPreview.textContent = "Solving‚Ä¶ this can take a few seconds.";
      try{
        const r = await photoSolve(fd);
        const text = (r && r.response) ? r.response : "No response text returned.";
        demoPreview.textContent = text;
      }catch(e){
        demoPreview.innerHTML = '<span class="dim">Photo solve failed. Please try again or open the full chat.</span>';
      }finally{
        // revoke in a bit so the user can still see the thumb
        setTimeout(()=> URL.revokeObjectURL(url), 30000);
      }
    });

    document.getElementById("year").textContent = new Date().getFullYear();
    reflectAuth();
  </script>
</body>
</html>