<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPTs Help – Learn Math with AI</title>
  <style>
    :root {
      --brand:#6f42c1;   /* Purple */
      --accent:#ffc107;  /* Amber */
      --bg:#f8f9fa;
      --text:#212529;
      --muted:#6c757d;
      --panel:#fff;
      --border:#eee;
      --shadow:0 16px 36px rgba(0,0,0,.08);
      --error:#dc3545;
      --ok:#198754;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;color:var(--text);background:var(--bg)}
    a{color:var(--brand);text-decoration:none}

    /* Header (single Login / Sign up area like ChatGPT) */
    header{background:#fff;border-bottom:1px solid #eee}
    .nav{max-width:1200px;margin:0 auto;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:800;letter-spacing:.2px}
    .nav-right{display:flex;gap:.5rem;align-items:center}
    .btn-nav{border:1px solid var(--border);background:#fff;color:var(--brand);padding:.55rem .9rem;border-radius:10px;cursor:pointer;font-weight:600}
    .btn-nav.primary{background:var(--brand);color:#fff;border-color:transparent}

    /* Hero */
    .hero{background:linear-gradient(135deg, var(--brand), #9c6fff);color:#fff;text-align:center;padding:5rem 2rem}
    .hero h1{font-size:clamp(2rem,4vw,3rem);margin-bottom:1rem}
    .hero p{font-size:1.1rem;max-width:720px;margin:0 auto 0;opacity:.98}

    /* Sections */
    .container{max-width:1200px;margin:0 auto;padding:2rem}
    h2{margin:.5rem 0}

    /* Features */
    .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.5rem;margin-top:2rem}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:1.5rem;box-shadow:0 4px 10px rgba(0,0,0,.05)}

    /* Try Photo Solve */
    .demo{margin-top:2rem;display:grid;grid-template-columns:1.2fr 1fr;gap:1.5rem}
    @media (max-width:960px){ .demo{grid-template-columns:1fr} }
    .demo-left, .demo-right{background:#fff;border:1px solid #eee;border-radius:14px;padding:1.25rem;box-shadow:var(--shadow)}
    .drop{border:2px dashed #ddd;border-radius:12px;padding:1.25rem;text-align:center;color:#555}
    .drop.drag{border-color:#c5b3f7;background:#faf6ff}
    .drop input{display:none}
    .small{color:var(--muted);font-size:.9rem}
    .demo-actions{display:flex;gap:.6rem;justify-content:center;margin-top:.75rem}
    .btn{padding:.85rem 1.2rem;font-weight:700;border:none;border-radius:10px;cursor:pointer}
    .btn-primary{background:var(--accent);color:#000}
    .btn-secondary{background:#fff;color:var(--brand);border:1px solid var(--border)}
    .preview{margin-top:1rem;display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}
    .preview img{max-width:220px;border-radius:10px;border:1px solid #eee}
    .result{background:#0f1117;color:#e7eaf1;border-radius:12px;padding:1rem;border:1px solid #222;margin-top:1rem;min-height:120px;white-space:pre-wrap}
    .spinner{
      width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;
      border-radius:50%;display:inline-block;vertical-align:-3px;animation:spin .7s linear infinite;margin-right:.35rem
    }
    .spinner.dark{border-color:#555;border-right-color:transparent}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Pricing */
    .plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-top:2rem}
    .plan{background:#fff;border:1px solid #eee;border-radius:14px;padding:2rem;position:relative;text-align:center;box-shadow:var(--shadow)}
    .plan h3{margin-bottom:.5rem}
    .price{font-size:2rem;color:var(--brand);margin:.5rem 0 1rem}
    .plan ul{list-style:none;padding:0;margin:1rem 0;color:var(--muted);text-align:left}
    .plan li{margin:.35rem 0}
    .badge{position:absolute;top:12px;right:12px;background:var(--brand);color:#fff;font-size:.75rem;padding:.25rem .5rem;border-radius:999px}

    /* Testimonials */
    .testimonials{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-top:2rem}
    .testimonial{background:#fff;border:1px solid #eee;border-radius:12px;padding:1.5rem;font-style:italic}

    footer{text-align:center;padding:2rem;color:var(--muted);margin-top:3rem;border-top:1px solid #eee}

    /* Modals (login/signup/paywall/reset) */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000}
    .overlay.open{display:flex}
    .modal{width:min(520px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:var(--shadow)}
    .modal h3{margin:.25rem 0 4px;font-size:1.15rem}
    .modal p.sub{color:var(--muted);margin:0 0 12px;font-size:.95rem}
    .row{display:flex;gap:.6rem}
    label{display:block;font-size:.9rem;color:var(--muted);margin:.35rem 0 .35rem}
    input[type="email"],input[type="password"],input[type="text"]{width:100%;padding:.75rem .9rem;border:1px solid #ddd;border-radius:10px;font-size:1rem}
    .modal .btn{width:100%}
    .close-x{border:0;background:transparent;color:#999;font-size:20px;cursor:pointer;float:right}
    .err{color:var(--error);font-size:.9rem;min-height:18px;margin-top:6px}
    .ok{color:var(--ok);font-size:.95rem;margin-top:8px}
    .muted{color:var(--muted);font-size:.9rem;margin-top:8px}
    .step{display:none}.step.active{display:block}
    .inline{display:flex;align-items:center;gap:.5rem}
    .link{color:var(--brand);background:none;border:0;padding:0;cursor:pointer;font-weight:600}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="nav">
      <div class="brand">GPTs Help</div>
      <div class="nav-right">
        <button id="openChatBtn" class="btn-nav" style="display:none" onclick="goToChat()">Open Chat</button>
        <button id="loginBtn" class="btn-nav">Log in</button>
        <button id="signupBtn" class="btn-nav primary">Sign up for free</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <h1>Snap → Solve. Master Math with AI.</h1>
    <p>Upload a math problem and get a step-by-step solution. Try it free — then unlock unlimited photo solves.</p>
  </section>

  <!-- Try Photo Solve (live) -->
  <section class="container">
    <h2>Try Photo Solve</h2>
    <div class="demo">
      <div class="demo-left">
        <div id="drop" class="drop">
          <strong>Drag & drop a math photo</strong><br/>
          <span class="small">or</span><br/>
          <button id="pickBtn" class="btn btn-secondary" type="button">Choose an image</button>
          <input id="fileInput" type="file" accept="image/png,image/jpeg,image/jpg,image/webp"/>
          <div class="small" style="margin-top:.6rem;">Free plan: <strong>2 photo solves</strong>. Upgrade for unlimited.</div>
        </div>
        <div id="preview" class="preview" aria-live="polite"></div>
        <div id="demoActions" class="demo-actions" style="display:none;">
          <button id="solveBtn" class="btn btn-primary" type="button">Solve Now</button>
          <button id="clearBtn" class="btn" type="button">Clear</button>
        </div>
      </div>
      <div class="demo-right">
        <div class="small" style="margin-bottom:.5rem;">Result</div>
        <div id="result" class="result">Upload a math question to see the step-by-step solution here.</div>
      </div>
    </div>
  </section>

  <!-- Features -->
  <section class="container">
    <h2>Why Choose GPTs Help?</h2>
    <div class="features">
      <div class="card"><h3>Step-by-Step Solutions</h3><p>Clear reasoning, multiple methods, and clean final answers.</p></div>
      <div class="card"><h3>Exam-Ready Practice</h3><p>Adaptive practice with instant feedback and hints.</p></div>
      <div class="card"><h3>LaTeX-quality Output</h3><p>Readable math formatting for neat notes and submissions.</p></div>
      <div class="card"><h3>Secure & Fast</h3><p>Trusted Paystack payments. Your data stays private.</p></div>
    </div>
  </section>

  <!-- Pricing -->
  <section class="container" id="pricing">
    <h2>Choose Your Plan</h2>
    <div class="plans">
      <!-- Free -->
      <div class="plan">
        <h3>Free Plan</h3>
        <div class="price">₵0 / mo</div>
        <ul>
          <li><strong>2 Photo Solves</strong></li>
          <li>Basic step-by-step answers</li>
          <li>Try before you buy</li>
        </ul>
        <button class="btn btn-secondary" id="startFreeBtn">Start free</button>
      </div>

      <!-- Plus Monthly -->
      <div class="plan">
        <div class="badge">Popular</div>
        <h3>Plus Monthly</h3>
        <div class="price">₵99 / mo</div>
        <ul>
          <li><strong>Unlimited Photo Solves</strong></li>
          <li>Advanced explanations & proofs</li>
          <li>Priority processing</li>
        </ul>
        <button class="btn btn-primary" id="plusMonthlyBtn">Subscribe Monthly</button>
      </div>

      <!-- Pro Annual -->
      <div class="plan">
        <h3>Pro Annual</h3>
        <div class="price">₵790 / yr</div>
        <ul>
          <li><strong>Unlimited Photo Solves</strong></li>
          <li>Annual discount (save 34%)</li>
          <li>Team sharing & exports</li>
        </ul>
        <button class="btn btn-primary" id="proAnnualBtn">Subscribe Annually</button>
      </div>
    </div>
  </section>

  <!-- Testimonials -->
  <section class="container">
    <h2>What Students Say</h2>
    <div class="testimonials">
      <div class="testimonial">“I finally understood calculus limits—your hints + step-by-step solved it!”<br><strong>— Ama A., Student</strong></div>
      <div class="testimonial">“Two photo solves hooked me. Upgraded the same day.”<br><strong>— Daniel K., SHS 3</strong></div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    &copy; <span id="year"></span> GPTs Help. All rights reserved.
  </footer>

  <!-- Log in Modal -->
  <div class="overlay" id="loginOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <button class="close-x" id="loginClose" aria-label="Close">×</button>
      <h3 id="loginTitle">Log in to GPTs Help</h3>
      <p class="sub">Use your account email and password.</p>

      <!-- Step 1: Email -->
      <div id="loginStepEmail" class="step active">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" placeholder="you@example.com" autocomplete="email" />
        <div class="err" id="loginEmailErr"></div>
        <button class="btn btn-primary" id="loginEmailContinue" type="button">Continue</button>
        <div class="muted" style="margin-top:10px;">New here? <a href="#" id="loginGoSignup">Create an account</a></div>
      </div>

      <!-- Step 2: Password -->
      <div id="loginStepPassword" class="step">
        <label>Email</label>
        <div class="inline" style="justify-content:space-between;">
          <div class="inline"><span id="loginEmailEcho" style="font-weight:600;"></span></div>
          <button class="link" id="loginChangeEmail" type="button">Change</button>
        </div>

        <label for="loginPassword" style="margin-top:8px;">Password</label>
        <input id="loginPassword" type="password" placeholder="••••••••" autocomplete="current-password" />
        <div class="err" id="loginErr"></div>
        <button class="btn btn-primary" id="loginSubmit" type="button">Log in</button>
        <div class="muted" style="margin-top:10px;">
          <a href="#" id="forgotPasswordLink">Forgot password?</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign up Modal -->
  <div class="overlay" id="signupOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
      <button class="close-x" id="signupClose" aria-label="Close">×</button>
      <h3 id="signupTitle">Create your free account</h3>
      <p class="sub">Start with the free plan. Upgrade anytime.</p>

      <!-- Step 1: Email -->
      <div id="signupStepEmail" class="step active">
        <label for="signupEmail">Email</label>
        <input id="signupEmail" type="email" placeholder="you@example.com" autocomplete="email" />
        <div class="err" id="signupEmailErr"></div>
        <button class="btn btn-primary" id="signupEmailContinue" type="button">Continue</button>
        <div class="muted" style="margin-top:10px;">Already have an account? <a href="#" id="signupGoLogin">Log in</a></div>
      </div>

      <!-- Step 2: Password -->
      <div id="signupStepPassword" class="step">
        <label>Email</label>
        <div class="inline" style="justify-content:space-between;">
          <div class="inline"><span id="signupEmailEcho" style="font-weight:600;"></span></div>
          <button class="link" id="signupChangeEmail" type="button">Change</button>
        </div>

        <label for="signupPassword" style="margin-top:8px;">Password</label>
        <input id="signupPassword" type="password" placeholder="At least 8 characters" autocomplete="new-password" />
        <label for="signupPassword2" style="margin-top:8px;">Confirm password</label>
        <input id="signupPassword2" type="password" placeholder="Re-enter password" autocomplete="new-password" />
        <div class="err" id="signupErr"></div>
        <button class="btn btn-primary" id="signupSubmit" type="button">Create account</button>
      </div>
    </div>
  </div>

  <!-- Paywall / Upgrade Modal -->
  <div class="overlay" id="paywallOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="paywallTitle">
      <button class="close-x" id="paywallClose" aria-label="Close">×</button>
      <h3 id="paywallTitle">You’ve reached your free photo limit</h3>
      <p class="sub">Upgrade to continue solving instantly. Unlimited photo solves with Plus or Pro.</p>
      <div class="row" style="margin-top:.5rem">
        <button class="btn" id="paywallMonthly">Get Plus Monthly</button>
        <button class="btn" id="paywallAnnual">Get Pro Annual</button>
      </div>
      <div class="muted" style="margin-top:.8rem;text-align:center">Already subscribed? <a href="/chat.html">Open Chat</a></div>
    </div>
  </div>

  <!-- Password Reset Modal -->
  <div class="overlay" id="resetOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="resetTitle">
      <button class="close-x" id="resetClose" aria-label="Close">×</button>
      <h3 id="resetTitle">Reset your password</h3>
      <p class="sub" id="resetSub">We’ll email you a secure link.</p>

      <!-- Step A: Request -->
      <div id="resetStepRequest" class="step active">
        <label for="resetEmail">Email</label>
        <input id="resetEmail" type="email" placeholder="you@example.com" autocomplete="email" />
        <div class="err" id="resetReqErr"></div>
        <div class="ok" id="resetReqOk" style="display:none;"></div>
        <button class="btn btn-primary" id="resetRequestBtn" type="button">Send reset link</button>
      </div>

      <!-- Step B: Confirm (when opened via ?reset=TOKEN) -->
      <div id="resetStepConfirm" class="step">
        <label for="resetPassword">New password</label>
        <input id="resetPassword" type="password" placeholder="At least 8 characters" autocomplete="new-password" />
        <label for="resetPassword2" style="margin-top:8px;">Confirm password</label>
        <input id="resetPassword2" type="password" placeholder="Re-enter password" autocomplete="new-password" />
        <div class="err" id="resetConfErr"></div>
        <div class="ok" id="resetConfOk" style="display:none;"></div>
        <button class="btn btn-primary" id="resetConfirmBtn" type="button">Set new password</button>
      </div>

      <div class="muted" id="resetFootNote" style="margin-top:10px;display:none;">Done! You can close this window and <a href="#" id="resetGoLogin">log in</a>.</div>
    </div>
  </div>

  <!-- Paystack -->
  <script src="https://js.paystack.co/v2/inline.js"></script>
  <script>
    const genRef = () => "gptshelp_" + Date.now() + "_" + Math.random().toString(36).slice(2,8);

    // Redirect after auth
    const urlParams = new URLSearchParams(location.search);
    const NEXT_URL = urlParams.get("next") || "/chat.html";

    // Plan codes (from your Paystack dashboard)
    const PLAN_CODE_PLUS_MONTHLY = "PLN_t8tii7sryvwsxxf";
    const PLAN_CODE_PRO_ANNUAL  = "PLN_3gkd3qo1pv8rylt";

    let PAYSTACK_PUBLIC_KEY = null;
    async function loadConfig(){
      try{
        const r = await fetch("/api/public-config");
        const cfg = await r.json();
        PAYSTACK_PUBLIC_KEY = cfg.paystackPublicKey || null;
      }catch{}
    }
    loadConfig();

    // API helpers
    async function apiMe(){ try{ return await fetch("/api/me",{credentials:"include"}).then(r=>r.json()); }catch{return{}} }
    async function apiLogin(email, password){
      const r = await fetch("/api/login", { method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include", body:JSON.stringify({email,password})});
      return r.json();
    }
    async function apiSignupFree(email, password){
      const r = await fetch("/api/signup-free", { method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include", body:JSON.stringify({email,password})});
      return r.json();
    }
    async function apiPwResetRequest(email){
      const r = await fetch("/api/password-reset/request", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ email }) });
      return r.json().catch(()=>({}));
    }
    async function apiPwResetConfirm(token, password){
      const r = await fetch("/api/password-reset/confirm", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ token, password }) });
      return r.json().catch(()=>({}));
    }

    function authOK(r){ return r && (r.status === "ok" || r.status === "success") && (r.user?.email || r.email); }
    function authEmail(r){ return (r && (r.user?.email || r.email)) || ""; }
    function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
    function goToChat(){ location.assign("/chat.html"); }
    function setBtnLoading(btn, loading, label){
      if(!btn) return;
      if(loading){ btn.disabled = true; btn.dataset.prev = btn.textContent; btn.innerHTML = '<span class="spinner"></span> ' + (label || btn.textContent || 'Working…'); }
      else { btn.disabled = false; btn.textContent = label || btn.dataset.prev || btn.textContent; }
    }

    // Header auth state
    async function reflectAuth(){
      const me = await apiMe();
      const openChatBtn = document.getElementById("openChatBtn");
      const loginBtn = document.getElementById("loginBtn");
      const signupBtn = document.getElementById("signupBtn");
      if(me?.status === "ok" && me.user?.email){
        openChatBtn.style.display = "inline-block";
        loginBtn.textContent = "Switch account";
        signupBtn.textContent = "New account";
      }else{
        openChatBtn.style.display = "none";
        loginBtn.textContent = "Log in";
        signupBtn.textContent = "Sign up for free";
      }
    }

    // ===== Log in modal =====
    const loginOverlay = document.getElementById("loginOverlay");
    const loginBtn = document.getElementById("loginBtn");
    const loginClose = document.getElementById("loginClose");
    const loginStepEmail = document.getElementById("loginStepEmail");
    const loginStepPassword = document.getElementById("loginStepPassword");
    const loginEmail = document.getElementById("loginEmail");
    const loginEmailErr = document.getElementById("loginEmailErr");
    const loginEmailContinue = document.getElementById("loginEmailContinue");
    const loginEmailEcho = document.getElementById("loginEmailEcho");
    const loginChangeEmail = document.getElementById("loginChangeEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginErr = document.getElementById("loginErr");
    const loginSubmit = document.getElementById("loginSubmit");
    const loginGoSignup = document.getElementById("loginGoSignup");
    const forgotPasswordLink = document.getElementById("forgotPasswordLink");

    function openLogin(){
      loginEmailErr.textContent=''; loginErr.textContent='';
      loginOverlay.classList.add("open"); loginOverlay.setAttribute("aria-hidden","false");
      loginStepEmail.classList.add("active"); loginStepPassword.classList.remove("active");
      setTimeout(()=>loginEmail.focus(),20);
    }
    function closeLogin(){ loginOverlay.classList.remove("open"); loginOverlay.setAttribute("aria-hidden","true"); }
    function handleLoginEmailContinue(){
      const e = loginEmail.value.trim();
      loginEmailErr.textContent='';
      if(!isValidEmail(e)){ loginEmailErr.textContent="Enter a valid email."; return; }
      loginEmailEcho.textContent=e;
      loginStepEmail.classList.remove("active");
      loginStepPassword.classList.add("active");
      setTimeout(()=>loginPassword.focus(),20);
    }
    async function handleLoginSubmit(){
      const email = loginEmailEcho.textContent.trim() || loginEmail.value.trim();
      const pw = loginPassword.value;
      if(!isValidEmail(email)){ loginStepPassword.classList.remove("active"); loginStepEmail.classList.add("active"); loginEmailErr.textContent="Enter a valid email."; return; }
      if(!pw){ loginErr.textContent="Enter your password."; return; }
      setBtnLoading(loginSubmit, true, "Log in");
      try{
        const r = await apiLogin(email, pw);
        if(authOK(r)){ localStorage.setItem("userEmail", authEmail(r)); location.replace(NEXT_URL); }
        else { loginErr.textContent = r?.message || "Invalid email or password."; }
      }catch{ loginErr.textContent="Could not log in. Check connection."; }
      finally{ setBtnLoading(loginSubmit, false, "Log in"); }
    }
    loginBtn.addEventListener('click', openLogin);
    loginClose.addEventListener('click', closeLogin);
    loginOverlay.addEventListener('click',(e)=>{ if(e.target===loginOverlay) closeLogin(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==="Escape" && loginOverlay.classList.contains("open")) closeLogin(); });
    loginEmailContinue.addEventListener('click', handleLoginEmailContinue);
    loginEmail.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleLoginEmailContinue(); });
    loginChangeEmail.addEventListener('click', ()=>{ loginStepPassword.classList.remove("active"); loginStepEmail.classList.add("active"); setTimeout(()=>loginEmail.focus(),20); });
    loginSubmit.addEventListener('click', handleLoginSubmit);
    loginPassword.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleLoginSubmit(); });
    loginGoSignup.addEventListener('click',(e)=>{ e.preventDefault(); closeLogin(); openSignup(); });

    // ===== Password Reset modal =====
    const resetOverlay = document.getElementById("resetOverlay");
    const resetClose   = document.getElementById("resetClose");
    const resetStepRequest = document.getElementById("resetStepRequest");
    const resetStepConfirm = document.getElementById("resetStepConfirm");
    const resetEmail   = document.getElementById("resetEmail");
    const resetReqErr  = document.getElementById("resetReqErr");
    const resetReqOk   = document.getElementById("resetReqOk");
    const resetRequestBtn = document.getElementById("resetRequestBtn");
    const resetPassword   = document.getElementById("resetPassword");
    const resetPassword2  = document.getElementById("resetPassword2");
    const resetConfErr    = document.getElementById("resetConfErr");
    const resetConfOk     = document.getElementById("resetConfOk");
    const resetConfirmBtn = document.getElementById("resetConfirmBtn");
    const resetFootNote   = document.getElementById("resetFootNote");
    const resetGoLogin    = document.getElementById("resetGoLogin");
    const resetSub        = document.getElementById("resetSub");

    function openReset(step='request'){
      resetReqErr.textContent=''; resetConfErr.textContent='';
      resetReqOk.style.display='none'; resetConfOk.style.display='none';
      resetFootNote.style.display='none';

      resetOverlay.classList.add("open"); resetOverlay.setAttribute("aria-hidden","false");
      if(step==='confirm'){ resetStepRequest.classList.remove('active'); resetStepConfirm.classList.add('active'); setTimeout(()=>resetPassword.focus(),20); }
      else { resetStepConfirm.classList.remove('active'); resetStepRequest.classList.add('active'); setTimeout(()=>resetEmail.focus(),20); }
    }
    function closeReset(){ resetOverlay.classList.remove("open"); resetOverlay.setAttribute("aria-hidden","true"); }
    resetClose.addEventListener('click', closeReset);
    resetOverlay.addEventListener('click',(e)=>{ if(e.target===resetOverlay) closeReset(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==="Escape" && resetOverlay.classList.contains("open")) closeReset(); });

    // Open reset from login
    forgotPasswordLink.addEventListener('click', (e)=>{
      e.preventDefault();
      const pref = (loginEmailEcho.textContent.trim() || loginEmail.value.trim());
      if(isValidEmail(pref)) resetEmail.value = pref;
      openReset('request');
    });

    // Request: send email
    resetRequestBtn.addEventListener('click', async ()=>{
      const email = resetEmail.value.trim();
      resetReqErr.textContent=''; resetReqOk.style.display='none';
      if(!isValidEmail(email)){ resetReqErr.textContent='Enter a valid email.'; return; }
      setBtnLoading(resetRequestBtn, true, 'Send reset link');
      try{
        await apiPwResetRequest(email); // always return generic ok
        resetReqOk.textContent = "If an account exists, a reset link has been sent.";
        resetReqOk.style.display='block';
      }catch{
        resetReqErr.textContent = "Could not send reset link. Please try again.";
      }finally{
        setBtnLoading(resetRequestBtn, false, 'Send reset link');
      }
    });

    // If opened via email link: ?reset=TOKEN
    const resetToken = urlParams.get('reset');
    if(resetToken){
      openReset('confirm');
      resetSub.textContent = "Enter a new password for your account.";
    }

    function pwOk(p){ return typeof p==='string' && p.length>=8; }

    // Confirm: set new password
    resetConfirmBtn.addEventListener('click', async ()=>{
      resetConfErr.textContent=''; resetConfOk.style.display='none';
      const p1 = resetPassword.value; const p2 = resetPassword2.value;
      if(!pwOk(p1)){ resetConfErr.textContent='Password must be at least 8 characters.'; return; }
      if(p1!==p2){ resetConfErr.textContent='Passwords do not match.'; return; }
      if(!resetToken){ resetConfErr.textContent='Missing or invalid reset link. Request a new one.'; return; }

      setBtnLoading(resetConfirmBtn, true, 'Set new password');
      try{
        const r = await apiPwResetConfirm(resetToken, p1);
        if(r && (r.status==='ok' || r.status==='success')){
          resetConfOk.textContent = 'Password updated. You can now log in.';
          resetConfOk.style.display='block';
          resetFootNote.style.display='block';
        }else{
          resetConfErr.textContent = r?.message || 'Reset failed. The link may be expired.';
        }
      }catch{
        resetConfErr.textContent = 'Network error. Please try again.';
      }finally{
        setBtnLoading(resetConfirmBtn, false, 'Set new password');
      }
    });

    resetGoLogin?.addEventListener('click', (e)=>{ e.preventDefault(); closeReset(); openLogin(); });

    // ===== Sign up modal =====
    const signupOverlay = document.getElementById("signupOverlay");
    const signupBtn = document.getElementById("signupBtn");
    const signupClose = document.getElementById("signupClose");
    const signupStepEmail = document.getElementById("signupStepEmail");
    const signupStepPassword = document.getElementById("signupStepPassword");
    const signupEmail = document.getElementById("signupEmail");
    const signupEmailErr = document.getElementById("signupEmailErr");
    const signupEmailContinue = document.getElementById("signupEmailContinue");
    const signupEmailEcho = document.getElementById("signupEmailEcho");
    const signupChangeEmail = document.getElementById("signupChangeEmail");
    const signupPassword = document.getElementById("signupPassword");
    const signupPassword2 = document.getElementById("signupPassword2");
    const signupErr = document.getElementById("signupErr");
    const signupSubmit = document.getElementById("signupSubmit");
    const signupGoLogin = document.getElementById("signupGoLogin");

    function openSignup(){
      signupEmailErr.textContent=''; signupErr.textContent='';
      signupOverlay.classList.add("open"); signupOverlay.setAttribute("aria-hidden","false");
      signupStepEmail.classList.add("active"); signupStepPassword.classList.remove("active");
      setTimeout(()=>signupEmail.focus(),20);
    }
    function closeSignup(){ signupOverlay.classList.remove("open"); signupOverlay.setAttribute("aria-hidden","true"); }
    function handleSignupEmailContinue(){
      const e = signupEmail.value.trim();
      signupEmailErr.textContent='';
      if(!isValidEmail(e)){ signupEmailErr.textContent="Enter a valid email."; return; }
      signupEmailEcho.textContent = e;
      signupStepEmail.classList.remove("active");
      signupStepPassword.classList.add("active");
      setTimeout(()=>signupPassword.focus(),20);
    }
    function passwordOk(p){ return typeof p === 'string' && p.length >= 8; }
    async function handleSignupSubmit(){
      signupErr.textContent='';
      const email = signupEmailEcho.textContent.trim() || signupEmail.value.trim();
      const p1 = signupPassword.value;
      const p2 = signupPassword2.value;
      if(!isValidEmail(email)){ signupStepPassword.classList.remove("active"); signupStepEmail.classList.add("active"); signupEmailErr.textContent="Enter a valid email."; return; }
      if(!passwordOk(p1)){ signupErr.textContent="Password must be at least 8 characters."; return; }
      if(p1!==p2){ signupErr.textContent="Passwords do not match."; return; }
      setBtnLoading(signupSubmit,true,"Create account");
      try{
        const r = await apiSignupFree(email, p1);
        if(authOK(r)){ localStorage.setItem("userEmail", authEmail(r)); location.replace(NEXT_URL); }
        else { signupErr.textContent = r?.message || "Sign up failed. Try again."; }
      }catch{ signupErr.textContent="Network error. Please try again."; }
      finally{ setBtnLoading(signupSubmit,false,"Create account"); }
    }
    signupBtn.addEventListener('click', openSignup);
    signupClose.addEventListener('click', closeSignup);
    signupOverlay.addEventListener('click',(e)=>{ if(e.target===signupOverlay) closeSignup(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==="Escape" && signupOverlay.classList.contains("open")) closeSignup(); });
    signupEmailContinue.addEventListener('click', handleSignupEmailContinue);
    signupEmail.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleSignupEmailContinue(); });
    signupChangeEmail.addEventListener('click', ()=>{ signupStepPassword.classList.remove("active"); signupStepEmail.classList.add("active"); setTimeout(()=>signupEmail.focus(),20); });
    signupSubmit.addEventListener('click', handleSignupSubmit);
    signupPassword2.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleSignupSubmit(); });
    signupGoLogin.addEventListener('click',(e)=>{ e.preventDefault(); closeSignup(); openLogin(); });

    // ===== Paywall modal + Paystack subscribe =====
    const paywallOverlay = document.getElementById("paywallOverlay");
    const paywallClose = document.getElementById("paywallClose");
    const paywallMonthly = document.getElementById("paywallMonthly");
    const paywallAnnual = document.getElementById("paywallAnnual");
    function openPaywall(){ paywallOverlay.classList.add("open"); paywallOverlay.setAttribute("aria-hidden","false"); }
    function closePaywall(){ paywallOverlay.classList.remove("open"); paywallOverlay.setAttribute("aria-hidden","true"); }
    paywallClose.addEventListener('click', closePaywall);
    paywallOverlay.addEventListener('click', (e)=>{ if(e.target===paywallOverlay) closePaywall(); });

    function startSubscription(planCode, label){
      if(!PAYSTACK_PUBLIC_KEY){ alert("Payment key not loaded yet. Please try again."); return; }
      apiMe().then(me=>{
        if(!(me?.status==="ok" && me.user?.email)){ openLogin(); return; }
        const email = me.user.email;
        const popup = new PaystackPop();
        popup.newTransaction({
          key: PAYSTACK_PUBLIC_KEY,
          email,
          currency: "GHS",
          plan: planCode,
          reference: genRef(),
          callback: (response) => {
            fetch("/api/paystack/verify", {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              credentials:"include",
              body: JSON.stringify({ reference: response.reference })
            })
            .then(r=>r.json())
            .then(r=>{
              if(r.status==="success" || r.status==="ok"){
                alert(label + " subscription activated!");
                closePaywall();
                location.href="/chat.html";
              }else{
                alert("Verification failed. Ref: " + response.reference);
              }
            })
            .catch(()=> alert("Verification request failed."));
          },
          onCancel: () => {}
        });
      });
    }
    paywallMonthly.addEventListener('click', ()=> startSubscription(PLAN_CODE_PLUS_MONTHLY, "Plus Monthly"));
    paywallAnnual.addEventListener('click', ()=> startSubscription(PLAN_CODE_PRO_ANNUAL, "Pro Annual"));

    // ===== Photo Solve DEMO logic =====
    const drop = document.getElementById("drop");
    const pickBtn = document.getElementById("pickBtn");
    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const solveBtn = document.getElementById("solveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const demoActions = document.getElementById("demoActions");
    const resultEl = document.getElementById("result");

    let selectedFile = null;

    // Drag & drop styling
    ;['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', (e)=>{
      const f = e.dataTransfer.files?.[0];
      if (f) handlePickedFile(f);
    });

    pickBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=> {
      const f = fileInput.files?.[0];
      if (f) handlePickedFile(f);
    });

    function handlePickedFile(file){
      if(!['image/png','image/jpeg','image/jpg','image/webp'].includes(file.type)){ alert('Choose a PNG, JPG, or WEBP image.'); return; }
      if(file.size > 6*1024*1024){ alert('Image is larger than 6MB.'); return; }
      selectedFile = file;
      preview.innerHTML = '';
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => URL.revokeObjectURL(url);
      img.src = url;
      preview.appendChild(img);
      demoActions.style.display = 'flex';
      resultEl.textContent = 'Ready. Click “Solve Now”.';
    }

    // free photo count key (by email)
    function photoCountKey(email){ return `photoCount:${email}`; }
    function getPhotoCount(email){
      try{ return parseInt(localStorage.getItem(photoCountKey(email))||'0',10) || 0; }catch{ return 0; }
    }
    function bumpPhotoCount(email){
      try{ const n = getPhotoCount(email)+1; localStorage.setItem(photoCountKey(email), String(n)); }catch{}
    }

    async function solveNow(){
      if(!selectedFile){ alert('Pick an image first.'); return; }

      // Must be logged in to call the real endpoint
      const me = await apiMe();
      if(!(me?.status==="ok" && me.user?.email)){ openSignup(); return; }

      const email = me.user.email;
      const plan = (me.user.plan || 'FREE').toUpperCase();

      // Free gate: only 2 uploads
      if(plan === 'FREE'){
        const used = getPhotoCount(email);
        if(used >= 2){
          openPaywall();
          return;
        }
      }

      // Call backend
      resultEl.textContent = '⏳ Solving…';
      setBtnLoading(solveBtn, true, "Solving…");

      try{
        const fd = new FormData();
        fd.append('image', selectedFile);
        fd.append('gptType', 'math');

        const r = await fetch('/api/photo-solve', { method:'POST', credentials:'include', body: fd });
        const j = await r.json();

        if(!r.ok || j.error){
          if(j?.status==='limit' || (j?.message||'').toLowerCase().includes('limit')){
            openPaywall();
          }else{
            resultEl.textContent = 'Sorry, photo solve failed. Please try again.';
          }
          return;
        }

        if(plan === 'FREE') bumpPhotoCount(email);

        const answer = j.response || 'No response text returned.';
        resultEl.textContent = answer;
      }catch(e){
        resultEl.textContent = 'Sorry, network error. Please try again.';
      }finally{
        setBtnLoading(solveBtn, false, "Solve Now");
      }
    }

    solveBtn.addEventListener('click', solveNow);
    clearBtn.addEventListener('click', ()=>{
      selectedFile = null; preview.innerHTML = ''; demoActions.style.display='none';
      resultEl.textContent = 'Upload a math question to see the step-by-step solution here.';
      fileInput.value = '';
    });

    // Pricing buttons
    const startFreeBtn   = document.getElementById("startFreeBtn");
    const plusMonthlyBtn = document.getElementById("plusMonthlyBtn");
    const proAnnualBtn   = document.getElementById("proAnnualBtn");

    startFreeBtn.addEventListener('click', ()=>{
      apiMe().then(me=>{
        if(me?.status==="ok" && me.user?.email){ location.assign("/chat.html"); }
        else { openSignup(); }
      });
    });
    plusMonthlyBtn.addEventListener('click', ()=> startSubscription(PLAN_CODE_PLUS_MONTHLY, "Plus Monthly"));
    proAnnualBtn.addEventListener('click', ()=> startSubscription(PLAN_CODE_PRO_ANNUAL, "Pro Annual"));

    // Year + header auth
    document.getElementById("year").textContent = new Date().getFullYear();
    reflectAuth();
  </script>
</body>
</html>
```0