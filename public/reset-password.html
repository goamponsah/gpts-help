<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reset your password – GPTs Help</title>
  <style>
    :root{ --brand:#6f42c1; --border:#e9ecef; --muted:#6c757d; --error:#dc3545; --ok:#198754; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f8f9fa;color:#212529}
    .wrap{max-width:560px;margin:5rem auto;padding:2rem;background:#fff;border:1px solid var(--border);border-radius:14px}
    h1{margin:.25rem 0 1rem}
    p{margin:.35rem 0 1rem;color:#343a40}
    label{display:block;margin:.5rem 0 .35rem;color:#495057}
    input[type="email"],input[type="password"]{width:100%;padding:.8rem .9rem;border:1px solid var(--border);border-radius:10px}
    .row{display:flex;gap:.6rem}
    .btn{padding:.8rem 1.2rem;border-radius:10px;border:1px solid var(--border);cursor:pointer;font-weight:700}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .muted{color:var(--muted);font-size:.95rem}
    .err{color:var(--error);min-height:18px;margin-top:.5rem}
    .ok{color:var(--ok);min-height:18px;margin-top:.5rem}
    .link{color:var(--brand);text-decoration:none}
    .hidden{display:none}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;vertical-align:-2px;animation:spin .7s linear infinite;margin-right:.4rem}
    .spinner.dark{border-color:#6c757d;border-right-color:transparent}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Reset your password</h1>
    <p class="muted">Enter your email to get a reset link. If you already have a link, open it and set a new password.</p>

    <!-- Step 1: Request link -->
    <div id="stepRequest">
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
      <div class="err" id="reqErr"></div>
      <button class="btn primary" id="reqBtn" type="button">Send reset link</button>
      <div class="ok hidden" id="reqOk"></div>
    </div>

    <!-- Step 2: Set new password -->
    <div id="stepReset" class="hidden">
      <p class="muted" id="tokenInfo"></p>
      <label for="pw1">New password</label>
      <input id="pw1" type="password" placeholder="At least 8 characters" autocomplete="new-password"/>
      <label for="pw2" style="margin-top:.6rem;">Confirm new password</label>
      <input id="pw2" type="password" placeholder="Re-enter password" autocomplete="new-password"/>
      <div class="err" id="setErr"></div>
      <button class="btn primary" id="setBtn" type="button">Set new password</button>
      <div class="ok hidden" id="setOk"></div>
    </div>

    <p class="muted" style="margin-top:1.25rem"><a class="link" href="/index.html">← Back to home</a></p>
  </div>

  <script>
    // --- helpers ---
    function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
    function setLoading(btn, loading, label){
      if(!btn) return;
      if(loading){
        btn.disabled = true;
        btn.dataset.prev = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span>' + (label || btn.textContent || 'Working…');
      }else{
        btn.disabled = false;
        btn.textContent = label || btn.dataset.prev || btn.textContent;
      }
    }

    const qs = new URLSearchParams(location.search);
    const token = qs.get('t');

    const stepRequest = document.getElementById('stepRequest');
    const stepReset = document.getElementById('stepReset');
    const tokenInfo = document.getElementById('tokenInfo');
    const reqBtn = document.getElementById('reqBtn');
    const setBtn = document.getElementById('setBtn');

    // If a token is present, show reset form
    if (token) {
      stepRequest.classList.add('hidden');
      stepReset.classList.remove('hidden');
      tokenInfo.textContent = 'Reset link detected. Create a new password below.';

      // Validate token (non-blocking) — server should return {valid: true|false}
      fetch('/api/reset/validate?token=' + encodeURIComponent(token), {credentials:'include'})
        .then(r => r.ok ? r.json() : {valid:false})
        .then(j => {
          if (!j || j.valid === false) {
            tokenInfo.textContent = 'This reset link is invalid or expired. Please request a new one.';
            setBtn.disabled = true;
          }
        })
        .catch(()=>{ /* ignore network hiccup, user can try submit */ });
    }

    // --- Step 1: Request reset link ---
    reqBtn.addEventListener('click', requestReset);
    document.getElementById('email').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); requestReset(); }
    });

    async function requestReset(){
      const email = document.getElementById('email').value.trim();
      const err = document.getElementById('reqErr');
      const ok = document.getElementById('reqOk');
      err.textContent = '';
      ok.classList.add('hidden'); ok.textContent = '';

      if (!isEmail(email)) { err.textContent = 'Enter a valid email.'; return; }

      setLoading(reqBtn, true, 'Sending…');
      try{
        const r = await fetch('/api/reset/request',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({email})
        });
        const j = await r.json().catch(()=>({}));
        ok.classList.remove('hidden');
        ok.textContent = 'If an account exists for ' + email + ', a reset link has been created. Check your email.';

        // Optional dev shortcut if the server returns a direct link (no email provider)
        if (j && j.devLink) {
          const a = document.createElement('a'); a.href = j.devLink; a.textContent = 'Open your reset link';
          a.style.display='inline-block'; a.style.marginTop='.5rem';
          ok.appendChild(document.createElement('br')); ok.appendChild(a);
        }
      }catch(e){
        err.textContent = 'Request failed. Please try again.';
      }finally{
        setLoading(reqBtn, false, 'Send reset link');
      }
    }

    // --- Step 2: Confirm new password ---
    setBtn.addEventListener('click', confirmReset);
    document.getElementById('pw2').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); confirmReset(); }
    });

    async function confirmReset(){
      const p1 = document.getElementById('pw1').value;
      const p2 = document.getElementById('pw2').value;
      const err = document.getElementById('setErr');
      const ok = document.getElementById('setOk');
      err.textContent = '';
      ok.classList.add('hidden'); ok.textContent = '';

      if (!token) { err.textContent = 'Missing reset token.'; return; }
      if (!p1 || p1.length < 8) { err.textContent = 'Password must be at least 8 characters.'; return; }
      if (p1 !== p2) { err.textContent = 'Passwords do not match.'; return; }

      setLoading(setBtn, true, 'Updating…');
      try{
        const r = await fetch('/api/reset/confirm',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({ token: token, newPassword: p1 })
        });
        const j = await r.json().catch(()=>({}));
        if (j && (j.status === 'ok' || j.success === true)) {
          ok.classList.remove('hidden');
          ok.textContent = 'Password updated. You are now signed in.';
          // small pause, then go to chat
          setTimeout(()=> location.href='/chat.html', 900);
        } else {
          err.textContent = (j && (j.message || j.error)) || 'Could not reset password.';
        }
      }catch(e){
        err.textContent = 'Request failed. Please try again.';
      }finally{
        setLoading(setBtn, false, 'Set new password');
      }
    }
  </script>
</body>
</html>