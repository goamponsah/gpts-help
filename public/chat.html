<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GPTs Help — Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --sidebar-w:280px;
      --bg:#0e0f13; --panel:#13141a; --muted:#9aa3b2; --text:#e7eaf1;
      --brand:#5865f2; --user:#1c2333; --assistant:#13141a; --border:#232634;
      --vh:100vh; --composer-h:88px; --menu-bg:#0f1117;
      --pill:#0f1117; --pill-border:#202433; --cta:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    a{color:#9aa3b2}
    .app{height:calc(var(--vh));display:grid;grid-template-columns:var(--sidebar-w) 1fr;}
    @media (max-width:900px){ .app{ grid-template-columns:1fr } .sidebar{ display:none } }
    .sidebar{position:relative;display:grid;grid-template-rows:auto 1fr auto;border-right:1px solid var(--border);background:#0f1117;min-height:0}
    .side-top{padding:12px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between}
    .logo{font-weight:700;letter-spacing:.2px}
    .new-chat{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;font-size:13px}
    .side-list{overflow-y:auto;padding:10px 8px 10px 12px;min-height:0}
    .conv{position:relative;display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid transparent;font-size:14px;margin-bottom:6px;white-space:nowrap;cursor:pointer}
    .conv:hover{background:#151824;border-color:#1b1f2b}
    .conv.active{background:#171b28;border-color:#2a3352}
    .conv-title{flex:1;overflow:hidden;text-overflow:ellipsis}
    .conv-menu-btn{opacity:0;transition:opacity .15s;border:0;background:transparent;color:var(--muted);cursor:pointer;padding:2px 4px;border-radius:6px}
    .conv:hover .conv-menu-btn{opacity:1}
    .menu{position:absolute;right:8px;top:32px;background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;display:none;z-index:10;min-width:180px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .menu.open{display:block}
    .menu button{display:block;width:100%;text-align:left;background:transparent;color:var(--text);border:0;padding:10px 12px;cursor:pointer;font-size:14px}
    .menu button:hover{background:#1a1d2a}
    .side-bottom{position:sticky;bottom:0;padding:10px;border-top:1px solid var(--border);background:#0f1117;display:grid;gap:8px}
    .usercard{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#10131b;cursor:pointer}
    .avatar{width:34px;height:34px;border-radius:50%;background:#1a2031;display:grid;place-items:center;color:#c8cee0;font-weight:700;font-size:12px;border:1px solid #22283a}
    .u-name{display:block;font-size:14px;font-weight:600;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px}
    .u-plan{display:block;margin-top:2px;font-size:12px;color:var(--muted)}
    .carat{color:#aab1c7}
    .main{display:grid;grid-template-rows:auto 1fr;min-height:0;height:100%}
    .messages{overflow-y:auto;padding:20px 18px calc(20px + var(--composer-h));min-height:0;scroll-behavior:smooth}
    .msg{max-width:900px;margin:0 auto 12px auto;display:flex}
    .bubble{max-width:68ch;padding:12px 14px;border:1px solid var(--border);border-radius:12px;line-height:1.55;font-size:15px;background:var(--assistant)}
    .msg.assistant{justify-content:flex-start}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:var(--user)}
    .thumb{display:block;max-width:240px;height:auto;border-radius:8px;margin-top:8px;border:1px solid var(--border)}
    .composer{position:fixed;left:var(--sidebar-w);right:0;bottom:0;z-index:30;border-top:1px solid var(--border);background:linear-gradient(#0e0f13,#0f1117);padding:10px 12px calc(10px + env(safe-area-inset-bottom,0px))}
    @media (max-width:900px){ .composer{ left:0 } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <!-- (existing HTML markup for sidebar, messages, composer, etc.) stays exactly the same --><script>
const messagesEl = document.getElementById('messages');
const convListEl = document.getElementById('convList');
const promptEl = document.getElementById('prompt');
const composerEl = document.getElementById('composer');
const sendBtn = document.getElementById('sendBtn');
const photoBtn = document.getElementById('photoBtn');
const photoFile = document.getElementById('photoFile');
const gptTypeEl = document.getElementById('gptType');
const statusEl = document.getElementById('status');
const newChatBtn = document.getElementById('newChatBtn');
const roBanner = document.getElementById('roBanner');
const welcome = document.getElementById('welcome');

/* --- Auto-titling helpers --- */
const convTitleCache = {};
const pendingAutoTitle = new Set();

function makeTitleFrom(text, prefix="") {
  const t0=(text||"").replace(/\s+/g," ").trim();
  if(!t0) return prefix?`${prefix}`:"New chat";
  let t=t0.replace(/^#{1,6}\s*/gm,"").replace(/\*\*(.*?)\*\*/g,"$1")
           .replace(/\*(.*?)\*/g,"$1").replace(/`{1,3}([\s\S]*?)`{1,3}/g,"$1")
           .replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/!\[(.*?)\]\((.*?)\)/g,"$1");
  t=t.split(/[\n\.!?]/)[0].trim()||t0;
  t=t.charAt(0).toUpperCase()+t.slice(1);
  const MAX=50; if(t.length>MAX) t=t.slice(0,MAX-1).trim()+"…";
  return prefix?`${prefix} ${t}`:t;
}
function shouldAutoTitleFor(convId){
  if(!convId) return true;
  if(pendingAutoTitle.has(convId)) return true;
  const t=(convTitleCache[convId]||"").trim().toLowerCase();
  return t==="new chat"||t==="untitled"||t==="";
}

/* API calls remain identical */
const api={...};

/* existing utility + render functions unchanged *//* Submit text */
document.getElementById('composer').addEventListener('submit', async (e)=>{
  e.preventDefault(); if(readOnly) return;
  const text=(promptEl.value||'').trim(); if(!text) return;
  renderMessage('user',text,now());
  sendBtn.disabled=true; photoBtn.disabled=true; promptEl.disabled=true; statusEl.textContent='Thinking…';
  try{
    const payload={message:text,gptType:'math'};
    if(currentConvId) payload.conversationId=currentConvId;
    const res=await api.chat(payload);

    if(!currentConvId && res.conversationId){
      currentConvId=res.conversationId;
      convTitleCache[currentConvId]='New chat';
      pendingAutoTitle.add(currentConvId);
      await loadConversations(currentConvId);
    }

    if(shouldAutoTitleFor(currentConvId)&&text){
      const autoTitle=makeTitleFrom(text);
      try{await api.renameConv(currentConvId,autoTitle);
        convTitleCache[currentConvId]=autoTitle;
        pendingAutoTitle.delete(currentConvId);
        await loadConversations(currentConvId);}catch{}
    }

    if(res.__status===403 && (res.status==='verify_required'||res.message?.toLowerCase().includes('verify'))){
      renderVerifyMessage();
    } else if(res.__status===402){
      renderQuotaMessage(res.message,res.upgradeLink);
    } else if(res.__status && res.__status!==200){
      renderMessage('assistant',res.message||'Sorry, something went wrong.');
    } else {
      renderMessage('assistant',typeof res?.response==='string'?res.response:'');
    }
  }catch{
    renderMessage('assistant','Sorry, something went wrong.');
  }finally{
    promptEl.value=''; sendBtn.disabled=false; photoBtn.disabled=false; promptEl.disabled=false; promptEl.focus(); statusEl.textContent='';
  }
});

/* Photo-solve auto-title identical to text */
photoFile.addEventListener('change', async ()=>{
  ...
  if(wasNew && res.conversationId){
    currentConvId=res.conversationId;
    convTitleCache[currentConvId]='New chat';
    pendingAutoTitle.add(currentConvId);
    await loadConversations(currentConvId);
  }
  if(shouldAutoTitleFor(currentConvId)){
    const autoTitle=makeTitleFrom(note||'Photo','Photo:');
    try{await api.renameConv(currentConvId,autoTitle);
      convTitleCache[currentConvId]=autoTitle;
      pendingAutoTitle.delete(currentConvId);
      await loadConversations(currentConvId);}catch{}
  }
  ...
});
</script>
</body>
</html>