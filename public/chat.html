<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GPTs Help â€” Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --sidebar-w:280px;
      --bg:#0e0f13;
      --panel:#13141a;
      --muted:#9aa3b2;
      --text:#e7eaf1;
      --brand:#5865f2;
      --border:#232634;
      --vh:100vh;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
    }

    /* Layout */
    .app{
      height:calc(var(--vh));
      display:grid;
      grid-template-columns:var(--sidebar-w) 1fr;
    }
    @media (max-width:900px){ .app{ grid-template-columns:1fr } .sidebar{ display:none } }

    /* Sidebar */
    .sidebar{
      display:grid; grid-template-rows:auto 1fr auto;
      border-right:1px solid var(--border); background:#0f1117; min-height:0;
    }
    .side-top{ padding:12px 12px; border-bottom:1px solid var(--border);
      display:flex; gap:8px; align-items:center; justify-content:space-between }
    .logo{ font-weight:700; letter-spacing:.2px }
    .new-chat{ background:var(--panel); color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:8px 10px; cursor:pointer; font-size:13px }
    .side-list{ overflow-y:auto; padding:10px 8px 10px 12px; min-height:0 }
    .conv{ position:relative; display:flex; align-items:center; gap:8px; padding:8px 10px;
      border-radius:10px; border:1px solid transparent; font-size:14px; margin-bottom:6px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer }
    .conv:hover{ background:#151824; border-color:#1b1f2b }
    .conv.active{ background:#171b28; border-color:#2a3352 }
    .conv-title{ flex:1; overflow:hidden; text-overflow:ellipsis }
    .conv-menu-btn{ opacity:0; transition:opacity .15s; border:0; background:transparent; color:var(--muted); cursor:pointer; padding:2px 4px; border-radius:6px }
    .conv:hover .conv-menu-btn{ opacity:1 }
    .menu{ position:absolute; right:8px; top:32px; background:var(--panel); border:1px solid var(--border); border-radius:10px; overflow:hidden; display:none; z-index:10 }
    .menu.open{ display:block }
    .menu button{ display:block; width:160px; text-align:left; background:transparent; color:var(--text); border:0; padding:10px 12px; cursor:pointer; font-size:14px }
    .menu button:hover{ background:#1a1d2a }
    .side-bottom{ position:sticky; bottom:0; padding:10px; border-top:1px solid var(--border); background:#0f1117 }
    .logout{ width:100%; background:transparent; border:1px solid var(--border); color:var(--text); padding:9px 10px; border-radius:10px; cursor:pointer; font-size:13px }
    .logout:hover{ background:#151824 }

    /* Main area: messages (1fr) + composer (auto) */
    .main{ display:grid; grid-template-rows:1fr auto; min-height:0 }
    .messages{
      overflow-y:auto; padding:20px 18px; min-height:0; scroll-behavior:smooth;
      background:radial-gradient(1200px 400px at 50% -200px, rgba(88,101,242,.08), transparent 60%);
    }
    .msg{
      max-width:900px; margin:0 auto 12px auto; padding:12px 14px;
      border:1px solid var(--border); border-radius:12px; background:var(--panel);
      line-height:1.55; font-size:15px;
      white-space:normal;
    }
    .msg.user{ background:#11131a }
    .msg small{ display:block; color:var(--muted); margin-bottom:6px }
    .thumb{ display:block; max-width:240px; height:auto; border-radius:8px; margin-top:8px; border:1px solid var(--border) }

    /* Nicer markdown defaults */
    .msg p{ margin:.4rem 0; }
    .msg h1,.msg h2,.msg h3{ margin:.6rem 0 .4rem; }
    .msg ul,.msg ol{ padding-left:1.2rem; margin:.4rem 0; }
    .msg code{ background:#0b0d12; padding:2px 6px; border-radius:6px; border:1px solid var(--border); }
    .msg pre{ background:#0b0d12; padding:10px; border-radius:10px; border:1px solid var(--border); overflow:auto; }

    /* Composer â€” compact, ChatGPT-like */
    .composer{
      border-top:1px solid var(--border);
      background:linear-gradient(#0e0f13,#0f1117);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom,0px));
    }
    .row{
      max-width:900px; margin:0 auto;
      display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
    }
    .input{
      display:flex; align-items:flex-end; gap:8px;
      background:#0f1117; border:1px solid var(--border);
      border-radius:9999px; padding:6px 10px;
      min-height:42px;
    }
    .ta-wrap{ flex:1; display:flex; flex-direction:column; }
    .meta{
      display:flex; gap:8px; align-items:center; color:var(--muted); font-size:11px; margin:2px 2px 4px 6px;
    }
    select{
      background:#0f1117; color:var(--text); border:1px solid var(--border);
      border-radius:8px; padding:4px 6px; font-size:11px;
    }
    textarea{
      width:100%; resize:none; min-height:24px; max-height:120px;
      background:transparent; color:var(--text); outline:none; border:0; font:inherit; line-height:1.45; padding:0 4px 2px 6px;
    }
    .controls{
      display:inline-flex; gap:6px;
    }
    .icon-btn{
      width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:9999px; border:1px solid var(--border); background:#141722; color:#dfe3ec;
      cursor:pointer; font-size:16px; line-height:1;
    }
    .icon-btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
    .icon-btn:disabled{ opacity:.6; cursor:not-allowed }
  </style>

  <!-- Markdown renderer + sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="side-top">
        <div class="logo">GPTs Help</div>
        <button class="new-chat" id="newChatBtn">+ New Chat</button>
      </div>

      <div class="side-list" id="convList"></div>

      <div class="side-bottom">
        <button class="logout" id="logoutBtn">Sign out</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="messages" id="messages"></div>

      <form class="composer" id="composer">
        <div class="row">
          <!-- compact pill input -->
          <div class="input">
            <div class="ta-wrap">
              <div class="meta">
                <label for="gptType">Assistant</label>
                <select id="gptType">
                  <option value="math">Math GPT</option>
                  <option value="content">ContentGPT</option>
                </select>
                <span id="status" style="margin-left:auto;"></span>
              </div>
              <textarea id="prompt" placeholder="Message Math GPTâ€¦" autocomplete="off"></textarea>
            </div>
          </div>

          <div class="controls">
            <button class="icon-btn" id="photoBtn" type="button" title="Photo Solve" aria-label="Photo Solve">ðŸ“·</button>
            <button class="icon-btn primary" id="sendBtn" type="submit" title="Send" aria-label="Send">âž¤</button>
            <input type="file" id="photoFile" accept="image/png,image/jpeg,image/jpg,image/webp" hidden />
          </div>
        </div>
      </form>
    </main>
  </div>

  <script>
    /* mobile 100vh fix */
    function setVh(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh*100}px`); }
    setVh(); window.addEventListener('resize', setVh);

    /* API (all with credentials so cookie session is sent) */
    const api = {
      listConvs: (email)=>fetch(`/api/conversations?userId=${encodeURIComponent(email)}`, { credentials:'include' }).then(r=>r.json()),
      createConv:(email,title)=>fetch('/api/conversations',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({userId:email,title})}).then(r=>r.json()),
      renameConv:(email,id,title)=>fetch(`/api/conversations/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({userId:email,title})}).then(r=>r.json()),
      deleteConv:(email,id)=>fetch(`/api/conversations/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({userId:email})}).then(r=>r.json()),
      getConvMsgs:(email,id)=>fetch(`/api/conversations/${id}?userId=${encodeURIComponent(email)}`, { credentials:'include' }).then(r=>r.json()),
      chat:(payload)=>fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)}).then(r=>r.json()),
      me:()=>fetch('/api/me', { credentials:'include' }).then(r=>r.json()),
      photoSolve:(fd)=>fetch('/api/photo-solve',{method:'POST',credentials:'include',body:fd}).then(r=>r.json()),
      logout:()=>fetch('/api/logout',{method:'POST',credentials:'include'})
    };

    /* Elements */
    const messagesEl = document.getElementById('messages');
    const convListEl = document.getElementById('convList');
    const promptEl = document.getElementById('prompt');
    const composerEl = document.getElementById('composer');
    const sendBtn = document.getElementById('sendBtn');
    const photoBtn = document.getElementById('photoBtn');
    const photoFile = document.getElementById('photoFile');
    const gptTypeEl = document.getElementById('gptType');
    const statusEl = document.getElementById('status');
    const newChatBtn = document.getElementById('newChatBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    let userEmail = localStorage.getItem('userEmail') || '';
    let currentConvId = null;

    /* Auth guard (cookie-based) */
    async function guardAuth(){
      try{
        const me = await api.me();
        if (me.status !== 'ok' || !me.user?.email) {
          window.location.replace('/index.html'); 
          return false;
        }
        userEmail = me.user.email;
        localStorage.setItem('userEmail', userEmail);
        return true;
      } catch {
        window.location.replace('/index.html');
        return false;
      }
    }

    /* Helpers */
    function el(tag, attrs={}, ...children){
      const e=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') e.className=v;
        else if(k.startsWith('on') && typeof v==='function') e.addEventListener(k.substring(2), v);
        else if(v!=null) e.setAttribute(k,v);
      });
      children.forEach(c=> typeof c==='string' ? e.appendChild(document.createTextNode(c)) : c && e.appendChild(c));
      return e;
    }

    // Clean text and make a short, neat title (ChatGPT-like)
    function makeTitleFrom(text, prefix="") {
      const t0 = (text || "").replace(/\s+/g, " ").trim();
      if (!t0) return prefix ? `${prefix}` : "New chat";

      // strip basic markdown and code fences/backticks
      let t = t0
        .replace(/^#{1,6}\s*/gm, "")
        .replace(/\*\*(.*?)\*\*/g, "$1")
        .replace(/\*(.*?)\*/g, "$1")
        .replace(/`{1,3}([\s\S]*?)`{1,3}/g, "$1")
        .replace(/\[(.*?)\]\((.*?)\)/g, "$1")
        .replace(/!\[(.*?)\]\((.*?)\)/g, "$1");

      // take first sentence/line-ish
      t = t.split(/[\n\.!?]/)[0].trim();
      if (!t) t = t0;

      // uppercase first letter
      t = t.charAt(0).toUpperCase() + t.slice(1);

      // length clamp ~50 chars
      const MAX = 50;
      if (t.length > MAX) t = t.slice(0, MAX - 1).trim() + "â€¦";

      return prefix ? `${prefix} ${t}` : t;
    }

    // Markdown-rendered assistant messages
    function renderMessage(role, text, when=''){
      const m = document.createElement('div');
      m.className = `msg ${role}`;

      if (when) {
        const small = document.createElement('small');
        small.textContent = when;
        m.appendChild(small);
      }

      if (role === 'assistant') {
        const html = DOMPurify.sanitize(marked.parse(text || '', { breaks: true }));
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        m.appendChild(wrapper);
      } else {
        m.appendChild(document.createTextNode(text || ''));
      }

      messagesEl.appendChild(m);
    }

    function renderImageMessage(caption,url){
      const m=el('div',{class:'msg user'});
      m.appendChild(document.createTextNode(caption||'ðŸ“· Photo uploaded'));
      if(url){ m.appendChild(el('img',{class:'thumb',src:url,alt:'uploaded image'})); }
      messagesEl.appendChild(m);
    }
    function clearMessages(){ messagesEl.innerHTML=''; }
    function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }
    function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

    /* Conversations UI */
    async function loadConversations(selectId=null){
      const list=await api.listConvs(userEmail);
      convListEl.innerHTML='';
      list.forEach(c=>{
        const row=el('div',{class:`conv ${c.id===selectId?'active':''}`});
        const title=el('div',{class:'conv-title'},c.title);
        const menuBtn=el('button',{class:'conv-menu-btn',title:'Options'},'â‹¯');
        const menu=el('div',{class:'menu'});
        const bShare=el('button',{},'Share link');
        const bRename=el('button',{},'Rename');
        const bDelete=el('button',{},'Delete');

        bShare.addEventListener('click',e=>{
          e.stopPropagation();
          const url=`${location.origin}/chat.html?c=${c.id}`;
          navigator.clipboard.writeText(url).catch(()=>{});
          menu.classList.remove('open');
        });

        bRename.addEventListener('click',async e=>{
          e.stopPropagation(); menu.classList.remove('open');
          const input=el('input',{value:c.title,style:'width:100%; background:#12131a; color:#e7eaf1; border:1px solid #232634; border-radius:6px; padding:6px 8px;'});
          row.replaceChild(input,title); input.focus();
          const commit=async ()=>{
            const t=(input.value||'New chat').trim();
            await api.renameConv(userEmail,c.id,t); await loadConversations(c.id);
          };
          input.addEventListener('keydown',ke=>{ if(ke.key==='Enter') commit(); if(ke.key==='Escape') loadConversations(c.id); });
          input.addEventListener('blur',commit);
        });

        bDelete.addEventListener('click',async e=>{
          e.stopPropagation(); menu.classList.remove('open');
          if(confirm('Delete this chat?')){ await api.deleteConv(userEmail,c.id); if(currentConvId===c.id){ currentConvId=null; clearMessages(); } await loadConversations(); }
        });

        menu.appendChild(bShare); menu.appendChild(bRename); menu.appendChild(bDelete);
        menuBtn.addEventListener('click',e=>{
          e.stopPropagation();
          document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open'));
          menu.classList.toggle('open');
        });

        row.addEventListener('click',async ()=>{
          currentConvId=c.id;
          document.querySelectorAll('.conv').forEach(n=>n.classList.remove('active'));
          row.classList.add('active');
          await showConversation(c.id);
        });

        row.appendChild(title); row.appendChild(menuBtn); row.appendChild(menu);
        convListEl.appendChild(row);
      });

      document.addEventListener('click',()=>{ document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open')); },{capture:true});
    }

    async function showConversation(id){
      clearMessages();
      const r=await api.getConvMsgs(userEmail,id);
      (r.messages||[]).forEach(m=> renderMessage(m.role==='user'?'user':'assistant', m.content));
      scrollToBottom();
    }

    /* Auto-resize + Enter to send */
    function autoresize(){
      promptEl.style.height='auto';
      promptEl.style.height=Math.min(120,promptEl.scrollHeight)+'px';
    }
    promptEl.addEventListener('input', autoresize);
    promptEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey && !e.isComposing){
        e.preventDefault();
        if(!sendBtn.disabled) composerEl.requestSubmit();
      }
    });

    /* Submit text */
    composerEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text=(promptEl.value||'').trim();
      if(!text) return;

      renderMessage('user', text, now()); scrollToBottom();

      sendBtn.disabled=true; photoBtn.disabled=true; promptEl.disabled=true; statusEl.textContent='Thinkingâ€¦';
      try{
        const payload={ message:text, gptType:gptTypeEl.value||'math', userId:userEmail };
        const isNew = !currentConvId;
        if(currentConvId) payload.conversationId=currentConvId;

        const res=await api.chat(payload);

        // If a new conversation was created, capture id and auto-name it
        if(isNew && res.conversationId){
          currentConvId = res.conversationId;
          const autoTitle = makeTitleFrom(text);
          try { await api.renameConv(userEmail, currentConvId, autoTitle); } catch {}
          await loadConversations(currentConvId);
        } else {
          await loadConversations(currentConvId||undefined);
        }

        renderMessage('assistant', res.response||'');
        scrollToBottom();
      }catch(err){
        renderMessage('assistant','Sorry, something went wrong. Please try again.'); scrollToBottom();
      }finally{
        promptEl.value=''; autoresize();
        sendBtn.disabled=false; photoBtn.disabled=false; promptEl.disabled=false; promptEl.focus(); statusEl.textContent='';
      }
    });

    /* Photo Solve */
    document.getElementById('photoBtn').addEventListener('click',()=> photoFile.click());
    photoFile.addEventListener('change', async ()=>{
      const file = photoFile.files && photoFile.files[0];
      if(!file) return;
      const okTypes=['image/png','image/jpeg','image/jpg','image/webp'];
      if(!okTypes.includes(file.type)){ alert('Please choose a PNG, JPG, or WEBP image.'); photoFile.value=''; return; }
      if(file.size>6*1024*1024){ alert('Image is larger than 6MB.'); photoFile.value=''; return; }

      const note = prompt('Optional: add a short note (what you tried). Leave blank if not needed.') || '';

      const objUrl=URL.createObjectURL(file);
      renderImageMessage(note ? `ðŸ“· (with note) ${note}` : 'ðŸ“· Photo uploaded', objUrl);
      scrollToBottom();

      sendBtn.disabled=true; photoBtn.disabled=true; promptEl.disabled=true; statusEl.textContent='Solvingâ€¦';
      try{
        const fd=new FormData();
        fd.append('image', file);
        fd.append('userId', userEmail);
        fd.append('gptType', gptTypeEl.value||'math');
        if(note) fd.append('attempt', note);
        if(currentConvId) fd.append('conversationId', currentConvId);

        const wasNew = !currentConvId;

        const res=await api.photoSolve(fd);

        // If a new conversation was created by photo-solve, auto-name it
        if(wasNew && res.conversationId){
          currentConvId = res.conversationId;
          const autoTitle = makeTitleFrom(note || 'Photo', 'Photo:');
          try { await api.renameConv(userEmail, currentConvId, autoTitle); } catch {}
          await loadConversations(currentConvId);
        } else {
          await loadConversations(currentConvId||undefined);
        }

        renderMessage('assistant', res.response||'No response text returned.');
        scrollToBottom();
      }catch(e){
        renderMessage('assistant','Photo solve failed. Please try another image.'); scrollToBottom();
      }finally{
        URL.revokeObjectURL(objUrl); photoFile.value='';
        sendBtn.disabled=false; photoBtn.disabled=false; promptEl.disabled=false; promptEl.focus(); statusEl.textContent='';
      }
    });

    /* New chat & logout */
    newChatBtn.addEventListener('click', async ()=>{
      const c=await api.createConv(userEmail,'New chat');
      currentConvId=c.id; await loadConversations(currentConvId); clearMessages(); promptEl.focus();
    });

    logoutBtn.addEventListener('click', async ()=>{
      try { await api.logout(); } catch {}
      localStorage.removeItem('userEmail');
      window.location.replace('/index.html');
    });

    /* Init */
    (async function init(){
      const ok=await guardAuth(); if(!ok) return;
      const p=new URLSearchParams(location.search); const fromUrl=p.get('c');
      await loadConversations(fromUrl?Number(fromUrl):null);
      if(fromUrl){ currentConvId=Number(fromUrl); await showConversation(currentConvId); }
      promptEl.focus(); autoresize();
    })();
  </script>
</body>
</html>
