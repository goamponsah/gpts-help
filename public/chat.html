<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GPTs Help — Chat</title>
  <style>
    :root{
      --bg:#0f1117; --panel:#121826; --text:#e7eaf1; --muted:#94a3b8;
      --border:#1f2a37; --user:#182033; --ai:#0b1220; --accent:#6f42c1; --accent2:#9c6fff;
      --sys:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0c1320,var(--bg));color:var(--text);
         font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

    /* Thread */
    .wrap{max-width:920px;margin:0 auto;padding:12px}
    .thread{padding:8px 0 120px}
    .row{display:flex;gap:10px;margin:10px 0}
    .row.user{justify-content:flex-end}
    .bubble{max-width:80%; padding:12px 14px; border-radius:14px; border:1px solid var(--border)}
    .row.user .bubble{background:var(--user)}
    .row.ai   .bubble{background:var(--ai)}
    .row.sys  .bubble{background:var(--sys); color:#e5e7eb}
    .time{font-size:.72rem;color:var(--muted);margin:0 4px}

    /* Composer */
    .composer{position:fixed;left:0;right:0;bottom:0;background:rgba(12,19,32,.85);
              backdrop-filter:blur(8px);border-top:1px solid var(--border)}
    .inner{max-width:920px;margin:0 auto;padding:10px;display:flex;gap:8px;align-items:flex-end}
    .select{color:#cbd5e1;background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:8px}
    textarea{flex:1;resize:none;min-height:46px;max-height:180px;padding:12px 14px;border-radius:12px;
             border:1px solid var(--border);background:#0b1220;color:#fff}
    .send{width:46px;height:46px;border-radius:12px;border:0;cursor:pointer;
          background:linear-gradient(135deg,var(--accent),var(--accent2))}
    .send[disabled]{opacity:.6;cursor:not-allowed}
    .spinner{width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;
             display:inline-block;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Toast (for quick notices) */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:96px;background:#1f2937;color:#fff;
           padding:10px 14px;border-radius:10px;border:1px solid var(--border);display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="thread" class="thread" aria-live="polite"></div>
  </div>

  <div class="composer">
    <div class="inner">
      <select id="assistantSel" class="select" aria-label="Assistant">
        <option value="math">Math GPT</option>
        <option value="write">Writing GPT</option>
      </select>
      <textarea id="input" placeholder="Message Math GPT..." rows="1"></textarea>
      <button id="sendBtn" class="send" aria-label="Send">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#fff" aria-hidden="true"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- elements ----------
    const threadEl = document.getElementById('thread');
    const inputEl  = document.getElementById('input');
    const sendBtn  = document.getElementById('sendBtn');
    const toast    = document.getElementById('toast');

    const urlParams = new URLSearchParams(location.search);
    let conversationId = Number(urlParams.get('id')) || null;
    let ME = null;

    // ---------- helpers ----------
    const fmtTime = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
    function showToast(t){ toast.textContent=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); }
    function addRow(kind, text){
      const row = document.createElement('div');
      row.className = 'row ' + kind;
      row.innerHTML = `<div class="time">${fmtTime(new Date())}</div><div class="bubble">${esc(text)}</div>`;
      threadEl.appendChild(row);
      threadEl.scrollTop = threadEl.scrollHeight;
      return row;
    }
    function setSending(s){
      sendBtn.disabled = s;
      sendBtn.innerHTML = s
        ? '<span class="spinner" aria-label="Sending"></span>'
        : '<svg width="20" height="20" viewBox="0 0 24 24" fill="#fff"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>';
    }

    // ---------- API ----------
    async function apiMe(){ try{ return await fetch('/api/me',{credentials:'include'}).then(r=>r.json()); }catch{return null;} }
    async function apiChat(payload){
      const r = await fetch('/api/chat',{
        method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',
        body:JSON.stringify(payload)
      });
      const j = await r.json().catch(()=>({}));
      return {ok:r.ok,status:r.status,data:j};
    }
    async function apiConvPatch(id, body){
      try{ await fetch(`/api/conversations/${id}`,{
        method:'PATCH',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body)
      }); }catch{}
    }

    // ---------- init ----------
    async function init(){
      ME = await apiMe();
      if(!(ME && ME.status==='ok')){
        // not logged in -> go home and come back
        location.replace('/index.html?next=/chat.html');
        return;
      }
      inputEl.focus();
    }

    // ---------- send ----------
    async function sendMessage(){
      const msg = inputEl.value.trim();
      if(!msg) return;

      inputEl.value = '';
      addRow('user', msg);
      setSending(true);

      const payload = { message: msg, gptType: document.getElementById('assistantSel').value, conversationId: conversationId || undefined };
      const res = await apiChat(payload).catch(()=>({ok:false,status:0,data:{}}));
      setSending(false);

      // auth / verify handling WITHOUT changing layout
      if(res.status === 401){
        addRow('sys', 'Please log in again.');
        setTimeout(()=>location.replace('/index.html?next=/chat.html'), 900);
        return;
      }
      if(res.status === 403 && (res.data?.error === 'verify_required' || res.data?.status === 'verify_required')){
        addRow('sys', '✉️ Please verify your email to continue. Check your inbox for the verification link.');
        return;
      }

      if(!res.ok || res.data?.error){
        if(res.status === 402 || res.data?.status === 'limit'){
          addRow('sys', 'You’ve reached the free limit. Visit the homepage to upgrade.');
        }else{
          addRow('sys', 'Sorry, something went wrong. Please try again.');
        }
        return;
      }

      const answer = res.data.response || '';
      conversationId = res.data.conversationId || conversationId;
      addRow('ai', answer);

      // auto-title like before: once we have a conv id, set title to first user message
      if(conversationId){
        const t = msg.slice(0, 40) || 'New chat';
        apiConvPatch(conversationId, { title: t });
      }
    }

    // events
    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    init();
  </script>
</body>
</html>
