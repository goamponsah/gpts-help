<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chat – GPTs Help</title>
  <style>
    :root{
      --brand:#6f42c1; --accent:#ffc107; --bg:#f8f9fa; --panel:#fff;
      --text:#212529; --muted:#6c757d; --border:#e9ecef; --shadow:0 16px 36px rgba(0,0,0,.08);
      --danger:#dc3545; --ok:#198754; --chip:#faf6ff
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}

    .app{display:grid;grid-template-columns:280px 1fr;height:100%}
    @media (max-width:900px){ .app{grid-template-columns:1fr} .sidebar{display:none} .sidebar.open{display:block;position:fixed;inset:0 30% 0 0;background:#fff;z-index:1000;border-right:1px solid var(--border)} }

    /* Sidebar */
    .sidebar{background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column}
    .side-head{padding:1rem;border-bottom:1px solid var(--border);display:flex;gap:.5rem;align-items:center;justify-content:space-between}
    .brand{font-weight:800}
    .side-actions{display:flex;gap:.5rem}
    .btn{padding:.6rem .9rem;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn.danger{background:#fff;color:var(--danger)}
    .convs{overflow:auto;padding:.75rem}
    .conv{padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px;margin-bottom:.6rem;background:#fff;cursor:pointer}
    .conv.active{border-color:var(--brand);box-shadow:0 0 0 2px rgba(111,66,193,.15)}
    .conv h4{margin:0 0 .2rem;font-size:.95rem}
    .muted{color:var(--muted)}
    .foot{margin-top:auto;padding:1rem;border-top:1px solid var(--border);font-size:.9rem}

    /* Main */
    .main{display:flex;flex-direction:column;min-width:0}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border);background:#fff}
    .title{font-weight:800}
    .top-right{display:flex;align-items:center;gap:.5rem}
    .chip{background:var(--chip);color:#5a3db6;border:1px solid #e6dcff;padding:.35rem .6rem;border-radius:999px;font-weight:600;font-size:.9rem}

    .thread{flex:1;overflow:auto;padding:1rem;scroll-behavior:smooth}
    .bubble{max-width:900px;margin:0 auto 1rem;background:#fff;border:1px solid var(--border);border-radius:14px;padding:1rem;box-shadow:0 4px 10px rgba(0,0,0,.035)}
    .bubble.assistant{background:#0f1117;color:#e7eaf1;border-color:#222}
    .bubble .role{font-weight:700;margin-bottom:.35rem;font-size:.9rem;opacity:.8}
    .bubble pre{white-space:pre-wrap;margin:0}
    .tools{display:flex;gap:.65rem;margin-top:.5rem;opacity:.9}
    .toolbtn{background:transparent;border:0;cursor:pointer;color:inherit;font-size:0}
    .toolbtn svg{width:20px;height:20px;stroke:currentColor}

    /* Composer */
    .composer{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(248,249,250,1),rgba(248,249,250,.9));padding:1rem;border-top:1px solid var(--border)}
    .composer-inner{max-width:900px;margin:0 auto;background:#fff;border:1px solid var(--border);border-radius:14px;padding:.75rem;box-shadow:var(--shadow)}
    .row{display:flex;gap:.6rem;align-items:flex-end}
    textarea{flex:1;min-height:52px;max-height:220px;resize:vertical;border:1px solid var(--border);border-radius:10px;padding:.7rem .8rem;font-size:1rem}
    .send{padding:.85rem 1.1rem;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:800;cursor:pointer}
    .iconbtn{width:42px;height:42px;display:inline-grid;place-items:center;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .iconbtn input{display:none}

    .preview{display:flex;gap:.75rem;align-items:center;margin-top:.6rem;flex-wrap:wrap}
    .preview .img{display:flex;align-items:center;gap:.6rem;border:1px dashed var(--border);border-radius:10px;padding:.5rem .6rem;background:#fff}
    .preview img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .note{min-width:220px;flex:1;border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem;font-size:.95rem}
    .x{border:0;background:transparent;cursor:pointer;color:var(--muted);font-size:18px}

    .spinner{width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-3px;animation:spin .7s linear infinite;margin-right:.35rem}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="side-head">
        <div class="brand">GPTs Help</div>
        <div class="side-actions">
          <button class="btn" id="newChatBtn">New chat</button>
        </div>
      </div>
      <div id="convList" class="convs" aria-live="polite"></div>
      <div class="foot">
        <div id="meEmail" class="muted">—</div>
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button id="logoutBtn" class="btn danger">Log out</button>
          <a class="btn" href="/index.html#pricing">Upgrade</a>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="title" id="convTitle">New chat</div>
        <div class="top-right">
          <span id="planChip" class="chip">Free</span>
        </div>
      </div>

      <div id="thread" class="thread" aria-live="polite"></div>

      <!-- Composer -->
      <div class="composer">
        <div class="composer-inner">
          <div class="row">
            <label class="iconbtn" title="Attach image">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6f42c1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              <input id="fileInput" type="file" accept="image/png,image/jpeg,image/jpg,image/webp"/>
            </label>
            <textarea id="msg" placeholder="Message Math GPT…" autocomplete="off"></textarea>
            <button id="sendBtn" class="send" type="button">Send</button>
          </div>

          <!-- Inline image preview + optional note (no pop-up) -->
          <div id="preview" class="preview" style="display:none">
            <div class="img">
              <img id="previewImg" alt="Selected image"/>
              <button class="x" id="clearImg" title="Remove">×</button>
            </div>
            <input id="photoNote" class="note" type="text" placeholder="Optional: add a short note (e.g., “the diagram is a right triangle”)."/>
            <button id="solveBtn" class="btn primary" type="button">Solve photo</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ===== Helpers ===== */
    const J = r => r.json();
    function fmtDate(d){ try{ return new Date(d).toLocaleString(); }catch{return ''} }
    function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
    function setBtnLoading(btn, loading, label){
      if(!btn) return;
      if(loading){ btn.disabled=true; btn.dataset.prev=btn.textContent; btn.innerHTML='<span class="spinner"></span>'+(label||btn.textContent); }
      else{ btn.disabled=false; btn.textContent=label||btn.dataset.prev||btn.textContent; }
    }

    /* ===== API ===== */
    async function apiMe(){ try{ return await fetch('/api/me',{credentials:'include'}).then(J); }catch{return{}} }
    async function apiConvs(){ return fetch('/api/conversations',{credentials:'include'}).then(J); }
    async function apiCreateConv(title){ return fetch('/api/conversations',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({title})}).then(J); }
    async function apiPatchConv(id, data){ return fetch('/api/conversations/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(data)}).then(J); }
    async function apiGetConv(id){ return fetch('/api/conversations/'+id,{credentials:'include'}).then(J); }
    async function apiLogout(){ return fetch('/api/logout',{method:'POST',credentials:'include'}).then(J); }
    async function apiFeedback(payload){ try{ await fetch('/api/feedback',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)}); }catch{} }

    /* ===== State ===== */
    let me = null;
    let convId = null;
    let convTitle = "New chat";
    let firstUserText = null; // used once for auto-title
    let selectedFile = null;

    const threadEl   = document.getElementById('thread');
    const convListEl = document.getElementById('convList');
    const convTitleEl= document.getElementById('convTitle');
    const planChip   = document.getElementById('planChip');

    /* ===== UI Builders ===== */
    function addBubble(role, content, createdAt=null){
      const wrap = el('div','bubble '+role);
      const roleEl = el('div','role'); roleEl.textContent = role==='assistant' ? 'Assistant' : 'You';
      wrap.appendChild(roleEl);

      const pre = el('pre'); pre.textContent = content || '';
      wrap.appendChild(pre);

      if(role==='assistant'){
        const tools = el('div','tools');
        tools.innerHTML = `
          <button class="toolbtn" title="Copy">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2"></rect>
              <path d="M5 15V5a2 2 0 0 1 2-2h10"></path>
            </svg>
          </button>
          <button class="toolbtn" data-like="up" title="Like">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 9V5a3 3 0 0 0-6 0v4"></path>
              <path d="M5 15h8a4 4 0 0 0 4-4V7a2 2 0 0 0-2-2h-1"></path>
            </svg>
          </button>
          <button class="toolbtn" data-like="down" title="Dislike">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 15v4a3 3 0 0 0 6 0v-4"></path>
              <path d="M19 9h-8a4 4 0 0 0-4 4v4a2 2 0 0 0 2 2h1"></path>
            </svg>
          </button>
        `;
        wrap.appendChild(tools);

        const [copyBtn, likeBtn, dislikeBtn] = tools.querySelectorAll('button');
        copyBtn.addEventListener('click', ()=> navigator.clipboard.writeText(content||'').catch(()=>{}));
        likeBtn.addEventListener('click', ()=> apiFeedback({conversationId: convId, messageIndex: null, kind:'like'}));
        dislikeBtn.addEventListener('click', ()=> apiFeedback({conversationId: convId, messageIndex: null, kind:'dislike'}));
      }

      if(createdAt){
        const ts = el('div','muted'); ts.style.marginTop='.35rem'; ts.textContent = fmtDate(createdAt);
        wrap.appendChild(ts);
      }

      threadEl.appendChild(wrap);
      threadEl.scrollTop = threadEl.scrollHeight;
    }

    function renderConvList(rows){
      convListEl.innerHTML = '';
      rows.forEach(r=>{
        const item = el('div','conv'+(r.id===convId?' active':'')); item.tabIndex=0;
        const h4 = el('h4'); h4.textContent = r.title || 'New chat'; item.appendChild(h4);
        const small = el('div','muted'); small.textContent = fmtDate(r.updated_at); item.appendChild(small);
        item.addEventListener('click', ()=> openConv(r.id, r.title));
        convListEl.appendChild(item);
      });
    }

    /* ===== Data Flow ===== */
    async function bootstrap(){
      me = await apiMe();
      if(me?.status!=='ok'){ location.replace('/index.html'); return; }
      document.getElementById('meEmail').textContent = me.user.email;
      planChip.textContent = (me.user.plan||'FREE').charAt(0)+ (me.user.plan||'FREE').slice(1).toLowerCase();
      const list = await apiConvs();
      renderConvList(list);
      if(list.length){
        openConv(list[0].id, list[0].title);
      }else{
        await newChat();
      }
    }

    async function newChat(){
      const c = await apiCreateConv('New chat');
      convId = c.id; convTitle = c.title || 'New chat'; firstUserText = null;
      convTitleEl.textContent = convTitle;
      highlightActive();
      threadEl.innerHTML = '';
      addBubble('assistant', 'What can I help with?');
    }

    function highlightActive(){
      document.querySelectorAll('.conv').forEach(div=>{
        div.classList.remove('active');
        const h = div.querySelector('h4')?.textContent||'';
        // crude way: rely on click re-render after list refresh; otherwise we toggle after openConv
      });
      // safer: refresh the list
      apiConvs().then(renderConvList).catch(()=>{});
    }

    async function openConv(id, title){
      convId = id; convTitle = title || 'New chat';
      firstUserText = null; // only used for *this* conversation; server stores title
      convTitleEl.textContent = convTitle;
      const data = await apiGetConv(id);
      threadEl.innerHTML='';
      (data.messages||[]).forEach(m=> addBubble(m.role, m.content, m.created_at));
      highlightActive();
    }

    /* ===== Composer actions ===== */
    const msgEl = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const previewImg = document.getElementById('previewImg');
    const photoNote = document.getElementById('photoNote');
    const clearImg = document.getElementById('clearImg');
    const solveBtn = document.getElementById('solveBtn');

    sendBtn.addEventListener('click', sendText);
    msgEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }});
    fileInput.addEventListener('change', ()=>{ const f = fileInput.files?.[0]; if(f) showPreview(f); });
    clearImg.addEventListener('click', ()=>{ clearPreview(); });
    solveBtn.addEventListener('click', solvePhoto);

    function showPreview(file){
      if(!['image/png','image/jpeg','image/jpg','image/webp'].includes(file.type)){ alert('Choose a PNG, JPG, or WEBP image.'); return; }
      if(file.size > 6*1024*1024){ alert('Image is larger than 6MB.'); return; }
      selectedFile = file;
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      preview.style.display='flex';
      photoNote.value = '';
    }
    function clearPreview(){
      selectedFile = null;
      preview.style.display='none';
      previewImg.removeAttribute('src');
      photoNote.value = '';
      fileInput.value = '';
    }

    async function sendText(){
      const text = (msgEl.value||'').trim();
      if(!text) return;

      // show immediately
      addBubble('user', text);
      msgEl.value='';

      // remember first user text for auto-title (only once per conversation)
      if(!firstUserText && convTitle === 'New chat') firstUserText = text;

      setBtnLoading(sendBtn,true,'Sending');
      try{
        const r = await fetch('/api/chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({ message:text, conversationId: convId })
        });
        if(r.status===403){ addBubble('assistant','Please verify your email to continue.'); return; }
        const j = await r.json();
        if(!r.ok || j.error){ addBubble('assistant','Sorry, something went wrong.'); return; }
        if(j.conversationId && j.conversationId!==convId){ convId = j.conversationId; }

        addBubble('assistant', j.response||'');

        // ----- Auto-title once, never overwrite again -----
        if(convTitle === 'New chat' && firstUserText){
          const generated = makeTitleFrom(firstUserText);
          try{
            const updated = await apiPatchConv(convId,{ title: generated });
            convTitle = updated.title||generated;
            convTitleEl.textContent = convTitle;
            firstUserText = null; // done; prevent future renames
            highlightActive();
          }catch{}
        }
      }catch{
        addBubble('assistant','Network error.');
      }finally{
        setBtnLoading(sendBtn,false,'Send');
      }
    }

    function makeTitleFrom(s){
      // simple heuristic: first sentence/line, max 48 chars
      let t = (s||'').replace(/\s+/g,' ').trim();
      const stop = Math.min(
        ...[t.indexOf('. '), t.indexOf('? '), t.indexOf('! ')]
          .filter(x=>x>0)
      );
      if(Number.isFinite(stop)) t = t.slice(0, stop+1);
      if(t.length>48) t = t.slice(0,45)+'…';
      if(!t) t = 'New chat';
      return t;
    }

    async function solvePhoto(){
      if(!selectedFile){ alert('Attach an image first.'); return; }
      // show synthetic user bubble
      const note = photoNote.value.trim();
      addBubble('user', (note? note+'\n\n' : '')+'[Photo attached]');

      setBtnLoading(solveBtn,true,'Solving');
      try{
        const fd = new FormData();
        fd.append('image', selectedFile);
        if(note) fd.append('attempt', note);
        if(convId) fd.append('conversationId', String(convId));

        const r = await fetch('/api/photo-solve',{ method:'POST', credentials:'include', body: fd });
        const j = await r.json();
        if(r.status===403){ addBubble('assistant','Please verify your email to continue.'); return; }
        if(r.status===402){ addBubble('assistant','You’ve reached your free photo limit. Upgrade to continue.'); return; }
        if(!r.ok || j.error){ addBubble('assistant','Sorry, photo solve failed.'); return; }

        if(j.conversationId && j.conversationId!==convId){ convId = j.conversationId; }
        addBubble('assistant', j.response||'');
        clearPreview();

        // auto-title (only if still New chat and we haven't used firstUserText)
        if(convTitle === 'New chat' && !firstUserText){
          // Use the note or a generic title
          const base = note || 'Photo solve';
          const generated = makeTitleFrom(base);
          try{
            const updated = await apiPatchConv(convId,{ title: generated });
            convTitle = updated.title||generated;
            convTitleEl.textContent = convTitle;
            highlightActive();
          }catch{}
        }
      }catch{
        addBubble('assistant','Network error.');
      }finally{
        setBtnLoading(solveBtn,false,'Solve photo');
      }
    }

    /* ===== Events: top/side ===== */
    document.getElementById('newChatBtn').addEventListener('click', newChat);
    document.getElementById('logoutBtn').addEventListener('click', async()=>{
      await apiLogout(); location.href='/';
    });

    // boot
    bootstrap();
  </script>
</body>
</html>