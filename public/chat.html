<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GPTs Help â€” Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --sidebar-w:280px;
      --bg:#0e0f13;
      --panel:#13141a;
      --muted:#9aa3b2;
      --text:#e7eaf1;
      --brand:#5865f2;
      --user:#1c2333;     /* user bubble */
      --assistant:#13141a;/* assistant bubble */
      --border:#232634;
      --vh:100vh;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
    }

    /* Layout */
    .app{
      height:calc(var(--vh));
      display:grid;
      grid-template-columns:var(--sidebar-w) 1fr;
    }
    @media (max-width:900px){
      .app{ grid-template-columns:1fr }
      .sidebar{ display:none }
    }
    /* Hide sidebar in viewer mode (shared read-only) */
    .viewer .sidebar{ display:none !important; }
    .viewer .app{ grid-template-columns:1fr !important; }

    /* Sidebar */
    .sidebar{
      display:grid; grid-template-rows:auto 1fr auto;
      border-right:1px solid var(--border); background:#0f1117; min-height:0;
    }
    .side-top{ padding:12px 12px; border-bottom:1px solid var(--border);
      display:flex; gap:8px; align-items:center; justify-content:space-between }
    .logo{ font-weight:700; letter-spacing:.2px }
    .new-chat{ background:var(--panel); color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:8px 10px; cursor:pointer; font-size:13px }
    .side-list{ overflow-y:auto; padding:10px 8px 10px 12px; min-height:0 }
    .conv{
      position:relative; display:flex; align-items:center; gap:8px; padding:8px 10px;
      border-radius:10px; border:1px solid transparent; font-size:14px; margin-bottom:6px;
      white-space:nowrap; overflow:visible; cursor:pointer;
    }
    .conv:hover{ background:#151824; border-color:#1b1f2b }
    .conv.active{ background:#171b28; border-color:#2a3352 }
    .conv-title{ flex:1; overflow:hidden; text-overflow:ellipsis }
    .conv-menu-btn{
      opacity:0; transition:opacity .15s; border:0; background:transparent;
      color:var(--muted); cursor:pointer; padding:2px 4px; border-radius:6px
    }
    .conv:hover .conv-menu-btn{ opacity:1 }
    .menu{
      position:absolute; right:8px; top:32px;
      background:var(--panel); border:1px solid var(--border); border-radius:10px;
      overflow:hidden; display:none; z-index:10; min-width:180px;
      box-shadow:0 10px 24px rgba(0,0,0,.35)
    }
    .menu.open{ display:block }
    .menu button{
      display:block; width:100%; text-align:left; background:transparent; color:var(--text);
      border:0; padding:10px 12px; cursor:pointer; font-size:14px
    }
    .menu button:hover{ background:#1a1d2a }
    .side-bottom{ position:sticky; bottom:0; padding:10px; border-top:1px solid var(--border); background:#0f1117 }
    .logout{ width:100%; background:transparent; border:1px solid var(--border); color:var(--text); padding:9px 10px; border-radius:10px; cursor:pointer; font-size:13px }
    .logout:hover{ background:#151824 }

    /* Main area: messages (1fr) + composer (auto) */
    .main{ display:grid; grid-template-rows:1fr auto; min-height:0 }
    .messages{
      overflow-y:auto; padding:20px 18px; min-height:0; scroll-behavior:smooth;
      background:radial-gradient(1200px 400px at 50% -200px, rgba(88,101,242,.08), transparent 60%);
    }

    /* Chat bubbles */
    .msg{ max-width:900px; margin:0 auto 12px auto; display:flex; }
    .bubble{
      max-width:68ch; padding:12px 14px; border:1px solid var(--border);
      border-radius:12px; line-height:1.55; font-size:15px; white-space:normal;
      background:var(--assistant);
    }
    .meta{ display:block; color:var(--muted); margin-bottom:6px; font-size:12px; }

    /* Assistant on LEFT */
    .msg.assistant{ justify-content:flex-start; }
    .msg.assistant .bubble{ background:var(--assistant); border-top-left-radius:8px; border-top-right-radius:12px; }
    .msg.assistant .meta{ text-align:left; }

    /* User on RIGHT */
    .msg.user{ justify-content:flex-end; }
    .msg.user .bubble{ background:var(--user); border-top-left-radius:12px; border-top-right-radius:8px; }
    .msg.user .meta{ text-align:right; }
    .msg.user .thumb{ margin-left:auto; }

    .thumb{ display:block; max-width:240px; height:auto; border-radius:8px; margin-top:8px; border:1px solid var(--border) }

    /* Nicer markdown defaults */
    .bubble p{ margin:.4rem 0; }
    .bubble h1,.bubble h2,.bubble h3{ margin:.6rem 0 .4rem; }
    .bubble ul,.bubble ol{ padding-left:1.2rem; margin:.4rem 0; }
    .bubble code{ background:#0b0d12; padding:2px 6px; border-radius:6px; border:1px solid var(--border); }
    .bubble pre{ background:#0b0d12; padding:10px; border-radius:10px; border:1px solid var(--border); overflow:auto; }

    /* Composer â€” compact, ChatGPT-like (bottom anchored via grid) */
    .composer{
      border-top:1px solid var(--border);
      background:linear-gradient(#0e0f13,#0f1117);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom,0px));
    }
    .row{
      max-width:900px; margin:0 auto;
      display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
    }
    .input{
      display:flex; align-items:flex-end; gap:8px;
      background:#0f1117; border:1px solid var(--border);
      border-radius:9999px; padding:6px 10px; min-height:42px;
    }
    .ta-wrap{ flex:1; display:flex; flex-direction:column; }
    .meta-row{
      display:flex; gap:8px; align-items:center; color:var(--muted); font-size:11px; margin:2px 2px 4px 6px;
    }
    select{
      background:#0f1117; color:var(--text); border:1px solid var(--border);
      border-radius:8px; padding:4px 6px; font-size:11px;
    }
    textarea{
      width:100%; resize:none; min-height:24px; max-height:120px;
      background:transparent; color:var(--text); outline:none; border:0; font:inherit; line-height:1.45; padding:0 4px 2px 6px;
    }
    .controls{ display:inline-flex; gap:6px; }
    .icon-btn{
      width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:9999px; border:1px solid var(--border); background:#141722; color:#dfe3ec;
      cursor:pointer; font-size:16px; line-height:1;
    }
    .icon-btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
    .icon-btn:disabled{ opacity:.6; cursor:not-allowed }

    /* Share modal */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .overlay.open{ display:flex; }
    .modal{
      width:min(560px, 92vw);
      background:#0f1117; border:1px solid var(--border); border-radius:16px;
      padding:18px; box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .modal-title{ font-weight:600; }
    .modal-sub{ color:var(--muted); font-size:13px; margin-bottom:12px; }
    .modal-row{
      display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
      background:#0f1117;
    }
    .modal input[type="text"]{
      width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:9999px;
      background:#0e0f13; color:var(--text); font-size:14px;
    }
    .btn{
      border:1px solid var(--border); background:#141722; color:var(--text);
      border-radius:9999px; padding:10px 14px; cursor:pointer; font-size:14px;
    }
    .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
    .modal-close{
      border:0; background:transparent; color:var(--muted); cursor:pointer; font-size:20px; line-height:1;
    }
    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      padding:10px 14px; font-size:13px; background:#141722; color:#e7eaf1; border:1px solid var(--border);
      border-radius:9999px; display:none; z-index:1100;
    }
    .toast.show{ display:block; }

    /* Viewer banner */
    .viewer-banner{
      background:#10131f; border-bottom:1px solid var(--border); color:#d7dbeb;
      padding:10px 14px; font-size:14px; display:none;
    }
    .viewer .viewer-banner{ display:block; }
  </style>

  <!-- Markdown renderer + sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <div class="viewer-banner" id="viewerBanner">
    ðŸ”— Youâ€™re viewing a shared chat (read-only). <a href="/index.html" style="color:#8fa2ff">Sign in</a> to start chatting.
  </div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="side-top">
        <div class="logo">GPTs Help</div>
        <button class="new-chat" id="newChatBtn">+ New Chat</button>
      </div>

      <div class="side-list" id="convList"></div>

      <div class="side-bottom">
        <button class="logout" id="logoutBtn">Sign out</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="messages" id="messages"></div>

      <form class="composer" id="composer">
        <div class="row">
          <!-- compact pill input -->
          <div class="input">
            <div class="ta-wrap">
              <div class="meta-row">
                <label for="gptType">Assistant</label>
                <select id="gptType">
                  <option value="math">Math GPT</option>
                  <option value="content">ContentGPT</option>
                </select>
                <span id="status" style="margin-left:auto;"></span>
              </div>
              <textarea id="prompt" placeholder="Message Math GPTâ€¦" autocomplete="off"></textarea>
            </div>
          </div>

          <div class="controls">
            <button class="icon-btn" id="photoBtn" type="button" title="Photo Solve" aria-label="Photo Solve">ðŸ“·</button>
            <button class="icon-btn primary" id="sendBtn" type="submit" title="Send" aria-label="Send">âž¤</button>
            <input type="file" id="photoFile" accept="image/png,image/jpeg,image/jpg,image/webp" hidden />
          </div>
        </div>
      </form>
    </main>
  </div>

  <!-- Share Modal -->
  <div class="overlay" id="shareOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
      <div class="modal-header">
        <div class="modal-title" id="shareTitle">Share public link to chat</div>
        <button class="modal-close" id="shareCloseBtn" aria-label="Close">Ã—</button>
      </div>
      <div class="modal-sub">Your name, custom instructions, and any messages you add after sharing stay private.</div>
      <div class="modal-row">
        <input type="text" id="shareLinkInput" placeholder="https://yourapp.com/chat.html?token=â€¦" readonly />
        <button class="btn primary" id="createShareBtn">Create link</button>
      </div>
    </div>
  </div>
  <div class="toast" id="toast">Link copied to clipboard</div>

  <script>
    /* mobile 100vh fix */
    function setVh(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh*100}px`); }
    setVh(); window.addEventListener('resize', setVh);

    /* API (all with credentials so cookie session is sent) */
    const api = {
      listConvs: ()=>fetch(`/api/conversations`, { credentials:'include' }).then(r=>r.json()),
      createConv:(title)=>fetch('/api/conversations',{
        method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
        body:JSON.stringify({title})
      }).then(r=>r.json()),
      updateConv:(id,patch)=>fetch(`/api/conversations/${id}`,{
        method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include',
        body:JSON.stringify(patch)
      }).then(r=>r.json()),
      deleteConv:(id)=>fetch(`/api/conversations/${id}`,{method:'DELETE',credentials:'include'}).then(r=>r.json()),
      getConvMsgs:(id)=>fetch(`/api/conversations/${id}`, { credentials:'include' }).then(r=>r.json()),
      chat:(payload)=>fetch('/api/chat',{
        method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
        body:JSON.stringify(payload)
      }).then(r=>r.json()),
      me:()=>fetch('/api/me', { credentials:'include' }).then(r=>r.json()),
      photoSolve: async (fd)=>{
        const r = await fetch('/api/photo-solve',{method:'POST',credentials:'include',body:fd});
        let j=null; try{ j = await r.json(); }catch{ j={}; }
        if(!r.ok){
          const msg = j?.error || (r.status===401?'Your session expired. Please log in again.':'Photo solve failed.');
          throw new Error(msg);
        }
        return j;
      },
      share:(id)=>fetch(`/api/conversations/${id}/share`, {method:'POST',credentials:'include'}).then(r=>r.json()),
      shareRead:(token)=>fetch(`/api/share/${encodeURIComponent(token)}`).then(r=>r.json()),
      logout:()=>fetch('/api/logout',{method:'POST',credentials:'include'})
    };

    /* Elements */
    const messagesEl = document.getElementById('messages');
    const convListEl = document.getElementById('convList');
    const promptEl = document.getElementById('prompt');
    const composerEl = document.getElementById('composer');
    const sendBtn = document.getElementById('sendBtn');
    const photoBtn = document.getElementById('photoBtn');
    const photoFile = document.getElementById('photoFile');
    const gptTypeEl = document.getElementById('gptType');
    const statusEl = document.getElementById('status');
    const newChatBtn = document.getElementById('newChatBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const viewerBanner = document.getElementById('viewerBanner');

    /* Share modal elements */
    const shareOverlay = document.getElementById('shareOverlay');
    const shareLinkInput = document.getElementById('shareLinkInput');
    const createShareBtn = document.getElementById('createShareBtn');
    const shareCloseBtn = document.getElementById('shareCloseBtn');
    const toastEl = document.getElementById('toast');

    let currentConvId = null;
    let pendingShareConvId = null;
    let viewerMode = false;
    let viewerToken = null;

    /* --- Dynamic placeholder tied to selected assistant --- */
    function updatePlaceholder() {
      const name = gptTypeEl.options[gptTypeEl.selectedIndex]?.text || "Assistant";
      promptEl.placeholder = `Message ${name}â€¦`;
      promptEl.setAttribute('aria-label', `Message ${name}`);
      promptEl.setAttribute('title', `Message ${name}`);
    }
    gptTypeEl.addEventListener('change', updatePlaceholder);

    /* Auth guard (cookie-based). If in viewer mode, allow unauthenticated. */
    async function guardAuth(allowGuest=false){
      try{
        const me = await api.me();
        if (me.status !== 'ok' || !me.user?.email) {
          if (allowGuest) return false; // not logged in, but okay for viewer
          window.location.replace('/index.html');
          return false;
        }
        return true;
      } catch {
        if (allowGuest) return false;
        window.location.replace('/index.html');
        return false;
      }
    }

    /* Helpers */
    function el(tag, attrs={}, ...children){
      const e=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') e.className=v;
        else if(k.startsWith('on') && typeof v==='function') e.addEventListener(k.substring(2), v);
        else if(v!=null) e.setAttribute(k,v);
      });
      children.forEach(c=> typeof c==='string' ? e.appendChild(document.createTextNode(c)) : c && e.appendChild(c));
      return e;
    }

    function showToast(msg='Link copied to clipboard'){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=> toastEl.classList.remove('show'), 1500);
    }

    // Clean text and make a short, neat title (ChatGPT-like)
    function makeTitleFrom(text, prefix="") {
      const t0 = (text || "").replace(/\s+/g, " ").trim();
      if (!t0) return prefix ? `${prefix}` : "New chat";
      let t = t0
        .replace(/^#{1,6}\s*/gm, "")
        .replace(/\*\*(.*?)\*\*/g, "$1")
        .replace(/\*(.*?)\*/g, "$1")
        .replace(/`{1,3}([\s\S]*?)`{1,3}/g, "$1")
        .replace(/\[(.*?)\]\((.*?)\)/g, "$1")
        .replace(/!\[(.*?)\]\((.*?)\)/g, "$1");
      t = t.split(/[\n\.!?]/)[0].trim();
      if (!t) t = t0;
      t = t.charAt(0).toUpperCase() + t.slice(1);
      const MAX = 50;
      if (t.length > MAX) t = t.slice(0, MAX - 1).trim() + "â€¦";
      return prefix ? `${prefix} ${t}` : t;
    }

    // Markdown-rendered assistant messages
    function renderMessage(role, text, when=''){
      const row = document.createElement('div');
      row.className = `msg ${role}`;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      if (when) {
        const small = document.createElement('small');
        small.className = 'meta';
        small.textContent = when;
        bubble.appendChild(small);
      }

      if (role === 'assistant') {
        const html = DOMPurify.sanitize(marked.parse(text || '', { breaks: true }));
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        bubble.appendChild(wrapper);
      } else {
        bubble.appendChild(document.createTextNode(text || ''));
      }

      row.appendChild(bubble);
      messagesEl.appendChild(row);
    }

    function renderImageMessage(caption,url){
      const row = document.createElement('div');
      row.className = 'msg user';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const small = document.createElement('small');
      small.className = 'meta';
      small.textContent = '';
      bubble.appendChild(small);
      bubble.appendChild(document.createTextNode(caption||'ðŸ“· Photo uploaded'));
      if(url){ const img=document.createElement('img'); img.className='thumb'; img.src=url; img.alt='uploaded image'; bubble.appendChild(img); }
      row.appendChild(bubble);
      messagesEl.appendChild(row);
    }

    function clearMessages(){ messagesEl.innerHTML=''; }
    function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }
    function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

    /* SHARE MODAL LOGIC */
    function openShareModal(convId){
      pendingShareConvId = convId;
      shareOverlay.classList.add('open');
      shareOverlay.setAttribute('aria-hidden','false');
      shareLinkInput.value = '';
      shareLinkInput.placeholder = `Creating secure linkâ€¦`;
      setTimeout(()=>createShareBtn.focus(), 10);
    }
    function closeShareModal(){
      shareOverlay.classList.remove('open');
      shareOverlay.setAttribute('aria-hidden','true');
      pendingShareConvId = null;
    }
    shareCloseBtn.addEventListener('click', closeShareModal);
    shareOverlay.addEventListener('click', (e)=>{ if(e.target === shareOverlay) closeShareModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && shareOverlay.classList.contains('open')) closeShareModal(); });

    createShareBtn.addEventListener('click', async ()=>{
      const id = pendingShareConvId ?? currentConvId;
      if(!id) return;
      createShareBtn.disabled = true;
      try{
        const r = await api.share(id); // { token }
        const url = `${location.origin}/chat.html?token=${encodeURIComponent(r.token)}`;
        shareLinkInput.value = url;
        shareLinkInput.select();
        await navigator.clipboard.writeText(url);
        createShareBtn.textContent = 'Copied!';
        showToast('Link copied to clipboard');
        setTimeout(()=>{ createShareBtn.textContent = 'Create link'; }, 1200);
      }catch(err){
        console.error(err);
        showToast('Could not create share link');
      }finally{
        createShareBtn.disabled = false;
      }
    });

    /* Conversations UI */
    async function loadConversations(selectId=null){
      const list=await api.listConvs(); // [{id,title,archived}]
      convListEl.innerHTML='';
      list
        .filter(c => !c.archived)
        .forEach(c=>{
          const row=el('div',{class:`conv ${c.id===selectId?'active':''}`});
          const title=el('div',{class:'conv-title'},c.title);
          const menuBtn=el('button',{class:'conv-menu-btn',title:'Options','aria-label':'Conversation options'},'â‹¯');
          const menu=el('div',{class:'menu'});
          const bShare=el('button',{},'Share');
          const bRename=el('button',{},'Rename');
          const bArchive=el('button',{},'Archive');
          const bDelete=el('button',{},'Delete');

          // SHARE â€” open modal
          bShare.addEventListener('click',e=>{
            e.stopPropagation();
            menu.classList.remove('open');
            openShareModal(c.id);
          });

          bRename.addEventListener('click',async e=>{
            e.stopPropagation(); menu.classList.remove('open');
            const input=el('input',{value:c.title,style:'width:100%; background:#12131a; color:#e7eaf1; border:1px solid #232634; border-radius:6px; padding:6px 8px;'});
            row.replaceChild(input,title); input.focus();
            const commit=async ()=>{
              const t=(input.value||'New chat').trim();
              await api.updateConv(c.id,{title:t}); await loadConversations(c.id);
            };
            input.addEventListener('keydown',ke=>{ if(ke.key==='Enter') commit(); if(ke.key==='Escape') loadConversations(c.id); });
            input.addEventListener('blur',commit);
          });

          bArchive.addEventListener('click', async e=>{
            e.stopPropagation(); menu.classList.remove('open');
            try{
              await api.updateConv(c.id,{ archived:true });
              if(currentConvId===c.id){ currentConvId=null; clearMessages(); }
              await loadConversations();
            }catch(err){
              alert('Archiving failed. Please try again.');
            }
          });

          bDelete.addEventListener('click',async e=>{
            e.stopPropagation(); menu.classList.remove('open');
            if(confirm('Delete this chat?')){
              await api.deleteConv(c.id);
              if(currentConvId===c.id){ currentConvId=null; clearMessages(); }
              await loadConversations();
            }
          });

          menu.appendChild(bShare);
          menu.appendChild(bRename);
          menu.appendChild(bArchive);
          menu.appendChild(bDelete);

          menuBtn.addEventListener('click',e=>{
            e.stopPropagation();
            document.querySelectorAll('.menu.open').forEach(m=>{ if(m!==menu) m.classList.remove('open'); });
            menu.classList.toggle('open');
          });

          row.addEventListener('click',async ()=>{
            currentConvId=c.id;
            document.querySelectorAll('.conv').forEach(n=>n.classList.remove('active'));
            row.classList.add('active');
            await showConversation(c.id);
          });

          row.appendChild(title); row.appendChild(menuBtn); row.appendChild(menu);
          convListEl.appendChild(row);
        });

      // Click outside to close menus
      document.addEventListener('click', (e)=>{
        if (!e.target.closest('.menu') && !e.target.closest('.conv-menu-btn')) {
          document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open'));
        }
      }, {capture:false});
    }

    async function showConversation(id){
      clearMessages();
      const r=await api.getConvMsgs(id);
      (r.messages||[]).forEach(m=> renderMessage(m.role==='user'?'user':'assistant', m.content));
      scrollToBottom();
    }

    /* Shared read-only viewer */
    async function showSharedConversation(token){
      clearMessages();
      try {
        const r = await api.shareRead(token); // {title, messages}
        (r.messages||[]).forEach(m=> renderMessage(m.role==='user'?'user':'assistant', m.content));
        scrollToBottom();
      } catch {
        renderMessage('assistant','The shared chat link is invalid or expired.');
      }
    }

    /* Auto-resize + Enter to send */
    function autoresize(){
      promptEl.style.height='auto';
      promptEl.style.height=Math.min(120,promptEl.scrollHeight)+'px';
    }
    promptEl.addEventListener('input', autoresize);
    promptEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey && !e.isComposing){
        e.preventDefault();
        if(!sendBtn.disabled) composerEl.requestSubmit();
      }
    });

    /* Submit text */
    composerEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(viewerMode) return;
      const text=(promptEl.value||'').trim();
      if(!text) return;

      renderMessage('user', text, now()); scrollToBottom();

      sendBtn.disabled=true; photoBtn.disabled=true; promptEl.disabled=true; statusEl.textContent='Thinkingâ€¦';
      try{
        const payload={ message:text, gptType:gptTypeEl.value||'math' };
        const isNew = !currentConvId;
        if(currentConvId) payload.conversationId=currentConvId;

        const res=await api.chat(payload);

        // If a new conversation was created, capture id and auto-name it
        if(isNew && res.conversationId){
          currentConvId = res.conversationId;
          const autoTitle = makeTitleFrom(text);
          try { await api.updateConv(currentConvId, { title: autoTitle }); } catch {}
          await loadConversations(currentConvId);
        } else {
          await loadConversations(currentConvId||undefined);
        }

        renderMessage('assistant', res.response||'');
        scrollToBottom();
      }catch(err){
        renderMessage('assistant', (err && err.message) ? err.message : 'Sorry, something went wrong. Please try again.');
        scrollToBottom();
      }finally{
        promptEl.value=''; autoresize();
        sendBtn.disabled=false; photoBtn.disabled=false; promptEl.disabled=false; promptEl.focus(); statusEl.textContent='';
      }
    });

    /* Photo Solve */
    document.getElementById('photoBtn').addEventListener('click',()=> !viewerMode && photoFile.click());
    photoFile.addEventListener('change', async ()=>{
      if(viewerMode) return;
      const file = photoFile.files && photoFile.files[0];
      if(!file) return;
      const okTypes=['image/png','image/jpeg','image/jpg','image/webp'];
      if(!okTypes.includes((file.type||'').toLowerCase())){ alert('Please choose a PNG, JPG, or WEBP image.'); photoFile.value=''; return; }
      if(file.size>6*1024*1024){ alert('Image is larger than 6MB.'); photoFile.value=''; return; }

      const note = prompt('Optional: add a short note (what you tried). Leave blank if not needed.') || '';

      const objUrl=URL.createObjectURL(file);
      renderImageMessage(note ? `ðŸ“· (with note) ${note}` : 'ðŸ“· Photo uploaded', objUrl);
      scrollToBottom();

      sendBtn.disabled=true; photoBtn.disabled=true; promptEl.disabled=true; statusEl.textContent='Solvingâ€¦';
      try{
        const fd=new FormData();
        fd.append('image', file);
        fd.append('gptType', gptTypeEl.value||'math');
        if(note) fd.append('attempt', note);
        if(currentConvId) fd.append('conversationId', currentConvId);

        const wasNew = !currentConvId;

        const res=await api.photoSolve(fd);

        if(wasNew && res.conversationId){
          currentConvId = res.conversationId;
          const autoTitle = makeTitleFrom(note || 'Photo', 'Photo:');
          try { await api.updateConv(currentConvId, { title: autoTitle }); } catch {}
          await loadConversations(currentConvId);
        } else {
          await loadConversations(currentConvId||undefined);
        }

        renderMessage('assistant', res.response||'No response text returned.');
        scrollToBottom();
      }catch(e){
        renderMessage('assistant', (e && e.message) ? e.message : 'Photo solve failed. Please try another image.');
        scrollToBottom();
      }finally{
        URL.revokeObjectURL(objUrl); photoFile.value='';
        sendBtn.disabled=false; photoBtn.disabled=false; promptEl.disabled=false; promptEl.focus(); statusEl.textContent='';
      }
    });

    /* New chat & logout */
    newChatBtn.addEventListener('click', async ()=>{
      if(viewerMode) return;
      const c=await api.createConv('New chat');
      currentConvId=c.id; await loadConversations(currentConvId); clearMessages(); promptEl.focus();
    });

    logoutBtn.addEventListener('click', async ()=>{
      try { await api.logout(); } catch {}
      window.location.replace('/index.html');
    });

    /* Init */
    (async function init(){
      const p=new URLSearchParams(location.search);
      const token=p.get('token');
      const fromUrl=p.get('c');

      viewerMode = !!token;
      viewerToken = token || null;

      if (viewerMode) {
        // viewer style toggles
        document.body.classList.add('viewer');
        // disable composer controls
        [sendBtn, photoBtn, promptEl].forEach(el => { el.disabled = true; });
        // hide new-chat + logout (still there if you want, but fine to keep)
        viewerBanner.style.display = 'block';
        await showSharedConversation(token);
        updatePlaceholder(); autoresize();
        return; // no auth required
      }

      const ok=await guardAuth(false); if(!ok) return;
      await loadConversations(fromUrl?Number(fromUrl):null);
      if(fromUrl){ currentConvId=Number(fromUrl); await showConversation(currentConvId); }
      updatePlaceholder(); 
      promptEl.focus(); autoresize();
    })();
  </script>
</body>
</html>

