<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GPTs Help ‚Äî Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --sidebar-w: 280px;
      --bg: #0e0f13;
      --panel: #13141a;
      --muted: #9aa3b2;
      --text: #e7eaf1;
      --brand: #5865f2;
      --user: #1c2333;
      --assistant: #13141a;
      --border: #232634;
      --vh: 100vh;
      --composer-h: 88px;
      --menu-bg: #0f1117;
      --pill: #0f1117;
      --pill-border: #202433;
      --cta: #22c55e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    }

    /* Layout basics */
    .app { display: grid; grid-template-columns: var(--sidebar-w) 1fr; height: var(--vh); }
    .messages { overflow-y: auto; padding: 20px 18px calc(20px + var(--composer-h)); }
    .msg { max-width: 900px; margin: 0 auto 12px auto; display: flex; }
    .bubble { padding: 12px 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 15px; line-height: 1.55; }
    .msg.user { justify-content: flex-end; }
    .msg.user .bubble { background: var(--user); }
    .msg.assistant { justify-content: flex-start; flex-direction: column; align-items: flex-start; } /* stack bubble + actions */
    .msg.assistant .bubble { background: var(--assistant); margin-bottom: 8px; } /* space above the action bar */

    /* Action bar below assistant replies */
    .msg.assistant .msg-actions {
      align-self: flex-start;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .msg-actions .act {
      background: transparent;
      color: inherit;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .msg-actions .sep {
      width: 1px;
      height: 18px;
      background: rgba(255, 255, 255, 0.12);
    }

    /* Composer */
    .composer {
      position: fixed;
      left: var(--sidebar-w);
      right: 0;
      bottom: 0;
      border-top: 1px solid var(--border);
      background: linear-gradient(#0e0f13, #0f1117);
      padding: 10px 12px;
    }
    .row { max-width: 900px; margin: 0 auto; display: flex; gap: 8px; align-items: center; }
    .input {
      flex: 1;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: #0f1117;
      border: 1px solid var(--border);
      border-radius: 9999px;
      padding: 6px 10px;
    }
    textarea {
      width: 100%;
      resize: none;
      background: transparent;
      color: var(--text);
      outline: none;
      border: 0;
      font: inherit;
      line-height: 1.45;
    }
    .controls { display: flex; gap: 6px; }
    .icon-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #141722;
      color: #dfe3ec;
      cursor: pointer;
      font-size: 16px;
    }
    .icon-btn.primary {
      background: var(--brand);
      color: #fff;
      border-color: transparent;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <div class="app">
    <div class="messages" id="messages"></div>
  </div>

  <form class="composer" id="composer">
    <div class="row">
      <div class="input">
        <textarea id="prompt" placeholder="Message Math GPT‚Ä¶" autocomplete="off"></textarea>
      </div>
      <div class="controls">
        <button class="icon-btn" id="photoBtn" type="button" title="Photo Solve">üì∑</button>
        <button class="icon-btn primary" id="sendBtn" type="submit">‚û§</button>
      </div>
    </div>
  </form>

  <input type="file" id="photoFile" accept="image/png,image/jpeg,image/jpg,image/webp" hidden />

  <script>
    const messagesEl = document.getElementById('messages');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const photoBtn = document.getElementById('photoBtn');
    const photoFile = document.getElementById('photoFile');
    let currentConvId = null;

    // === TTS Controller (Speak/Pause/Resume) ===
    const tts = { utter: null, bubble: null, btn: null };
    function ttsReset() {
      if (tts.btn) tts.btn.innerHTML = 'üîä Speak';
      tts.utter = null; tts.bubble = null; tts.btn = null;
    }
    function toggleSpeakFor(bubble, btn) {
      const text = bubble?.innerText || bubble?.textContent || '';
      if (!text) return;
      if (tts.utter && tts.bubble === bubble) {
        if (speechSynthesis.paused) {
          speechSynthesis.resume(); btn.innerHTML = '‚è∏ Pause';
        } else if (speechSynthesis.speaking) {
          speechSynthesis.pause(); btn.innerHTML = 'üîä Resume';
        } else {
          speechSynthesis.cancel(); ttsReset(); toggleSpeakFor(bubble, btn);
        }
        return;
      }
      if (speechSynthesis.speaking || speechSynthesis.paused) {
        speechSynthesis.cancel(); ttsReset();
      }
      const u = new SpeechSynthesisUtterance(text);
      tts.utter = u; tts.bubble = bubble; tts.btn = btn;
      btn.innerHTML = '‚è∏ Pause';
      u.onend = ttsReset; u.onerror = ttsReset;
      speechSynthesis.speak(u);
    }

    // === Message rendering ===
    function renderMessage(role, text) {
      const row = document.createElement('div');
      row.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      if (role === 'assistant') {
        const html = DOMPurify.sanitize(marked.parse(text || '', { breaks: true }));
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        bubble.appendChild(wrapper);
      } else {
        bubble.textContent = text;
      }

      row.appendChild(bubble);

      // Add Copy | Speak | Share buttons only for assistant
      if (role === 'assistant') {
        const actions = document.createElement('div');
        actions.className = 'msg-actions';
        actions.innerHTML = `
          <button class="act" data-act="copy">üìã Copy</button>
          <span class="sep"></span>
          <button class="act" data-act="speak">üîä Speak</button>
          <span class="sep"></span>
          <button class="act" data-act="share">üîó Share</button>
        `;
        row.appendChild(actions);

        actions.addEventListener('click', async (e) => {
          const btn = e.target.closest('button.act');
          if (!btn) return;
          const act = btn.dataset.act;
          if (act === 'copy') {
            const txt = bubble.innerText || bubble.textContent || '';
            await navigator.clipboard.writeText(txt);
          } else if (act === 'speak') {
            toggleSpeakFor(bubble, btn);
          } else if (act === 'share') {
            alert('Share feature coming soon.');
          }
        });
      }

      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // === Composer ===
    document.getElementById('composer').addEventListener('submit', (e) => {
      e.preventDefault();
      const text = promptEl.value.trim();
      if (!text) return;
      renderMessage('user', text);
      setTimeout(() => renderMessage('assistant', 'This is a sample Math GPT reply.'), 600);
      promptEl.value = '';
    });

    // === Image upload ===
    photoBtn.addEventListener('click', () => photoFile.click());
    photoFile.addEventListener('change', () => {
      const file = photoFile.files[0];
      if (!file) return;
      const objUrl = URL.createObjectURL(file);
      renderMessage('user', 'üì∑ Photo uploaded');
      setTimeout(() => renderMessage('assistant', 'Analyzing photo...'), 600);
      URL.revokeObjectURL(objUrl);
      photoFile.value = '';
    });
  </script>
</body>
</html>