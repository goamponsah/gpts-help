<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Math GPT â€” Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e0f13;
      --panel:#13141a;
      --muted:#9aa3b2;
      --text:#e7eaf1;
      --brand:#5865f2;
      --user:#1c2333;     /* user bubble */
      --assistant:#13141a;/* assistant bubble */
      --border:#232634;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
    }

    .wrap{
      display:grid;
      grid-template-rows: 1fr auto;
      height:100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* Chat area */
    .chat{
      padding: 20px 16px 8px;
      overflow:auto;
    }

    .msg{
      display:flex;
      gap:10px;
      margin: 10px 0;
      align-items:flex-end;
    }
    .msg.user{justify-content:flex-end}
    .bubble{
      max-width: 78ch;
      padding: 12px 14px;
      border:1px solid var(--border);
      border-radius: 16px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .msg.user .bubble{
      background: var(--user);
    }
    .msg.assistant .bubble{
      background: var(--assistant);
    }

    .bubble img{
      max-width: 360px; height:auto; display:block; border-radius:10px; margin-top:8px;
      border:1px solid var(--border);
    }

    /* Composer fixed at bottom */
    .composer{
      position:sticky;
      bottom:0;
      background: linear-gradient(180deg, rgba(14,15,19,0) 0%, var(--bg) 24%);
      padding: 12px 10px 18px;
      border-top: 1px solid var(--border);
    }
    .bar{
      display:flex;
      gap:8px;
      align-items:center;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 8px;
    }
    .bar input[type="file"]{
      display:none;
    }
    .bar button, .bar label{
      border:1px solid var(--border);
      background:#141622;
      color:var(--text);
      padding:8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .bar button:disabled{opacity:.6; cursor:not-allowed}
    .bar textarea{
      flex:1;
      resize:none;
      min-height: 24px;
      max-height: 120px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 16px;
      line-height: 1.35;
      padding: 8px;
    }
    .hint{color:var(--muted); font-size:12px; margin-top:6px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 16px; border-bottom:1px solid var(--border); background:var(--panel);
      position:sticky; top:0; z-index:10;
    }
    .brand{font-weight:700}
  </style>
  <!-- MathJax for LaTeX -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']], displayMath: [['$$','$$']] },
      svg: { scale: 1, minScaleAdjust: 100 }, options: { skipHtmlTags: ['script','noscript','style','textarea','pre'] }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="brand">Math GPT</div>
    <div class="hint">Type a prompt or add a photo. Press Enter to send.</div>
  </div>

  <div class="wrap">
    <div id="chat" class="chat"></div>

    <div class="composer">
      <div class="bar">
        <label for="image">ðŸ“· Photo</label>
        <input id="image" type="file" accept="image/*" />
        <textarea id="prompt" rows="1" placeholder="Message Math GPT..."></textarea>
        <button id="send">Send</button>
      </div>
      <div class="hint" id="fileName"></div>
    </div>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const promptEl = document.getElementById('prompt');
    const imageEl = document.getElementById('image');
    const sendBtn = document.getElementById('send');
    const fileNameEl = document.getElementById('fileName');

    // Show selected file name
    imageEl.addEventListener('change', () => {
      fileNameEl.textContent = imageEl.files[0] ? `Selected: ${imageEl.files[0].name}` : '';
    });

    // Auto-resize textarea
    promptEl.addEventListener('input', () => {
      promptEl.style.height = 'auto';
      promptEl.style.height = Math.min(promptEl.scrollHeight, 120) + 'px';
    });

    // Enter to send (Shift+Enter for newline)
    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
    sendBtn.addEventListener('click', send);

    function addMessage(role, html, imageURL) {
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      // Strip leading markdown headings "## **" etc. for cleanliness
      const cleaned = (html || '')
        .replace(/^\s*#+\s*\**/gm, '')      // remove markdown headings like ## **Title**
        .replace(/^\s*\*\*(.+?)\*\*\s*$/gm, '$1'); // bold-only header lines

      bubble.innerHTML = cleaned;
      if (imageURL) {
        const img = document.createElement('img');
        img.src = imageURL;
        bubble.appendChild(img);
      }
      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;

      // Typeset LaTeX after adding
      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise([bubble]).catch(() => {});
      }
    }

    async function send() {
      const message = promptEl.value.trim();
      const file = imageEl.files[0] || null;
      if (!message && !file) return;

      // Show user message + image preview
      let previewURL = null;
      if (file) {
        previewURL = URL.createObjectURL(file);
      }
      addMessage('user', message || '(photo only)', previewURL);

      // disable controls while sending
      sendBtn.disabled = true;
      promptEl.disabled = true;

      try {
        const form = new FormData();
        if (message) form.append('message', message);
        if (file) form.append('image', file);

        const resp = await fetch('/api/chat', { method: 'POST', body: form });
        const data = await resp.json();

        if (!resp.ok) {
          addMessage('assistant', `Sorry, an error occurred.\n\n${data?.detail || data?.error || 'Unknown error'}`);
        } else {
          const text = (data && data.answer) ? data.answer : 'No response text returned.';
          addMessage('assistant', text);
        }
      } catch (err) {
        addMessage('assistant', 'Network error. Please try again.');
      } finally {
        // reset
        sendBtn.disabled = false;
        promptEl.disabled = false;
        promptEl.value = '';
        promptEl.style.height = 'auto';
        imageEl.value = '';
        fileNameEl.textContent = '';
        promptEl.focus();
      }
    }
  </script>
</body>
</html>
