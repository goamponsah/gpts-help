<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GPTs Help â€” Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7fb;
      --panel:#ffffff;
      --border:#e7e7ef;
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#0b57d0;
      --accent:#4e54c8;
      --danger:#e11d48;
      --hover:#f2f4f8;
      --sidebar:#f9fafc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      line-height:1.45;
    }
    a{color:var(--primary)}
    .app{
      display:grid;
      grid-template-columns:280px 1fr;
      height:100vh;
      overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      background:var(--sidebar);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      height:100vh;
      position:relative;
    }
    .sidebar .top{
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .brand{
      font-weight:700;
      color:#111827;
      font-size:15px;
      letter-spacing:.2px;
    }
    .mode-switch{
      margin-left:auto;
      display:flex;
      gap:6px;
      background:#eceef6;
      padding:4px;
      border-radius:10px;
    }
    .mode-switch button{
      border:0;
      background:transparent;
      padding:6px 10px;
      border-radius:8px;
      font-weight:600;
      color:#374151;
      cursor:pointer;
    }
    .mode-switch button.active{
      background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
      color:#111827;
    }

    .new-chat{
      display:block;
      margin:12px;
      width:calc(100% - 24px);
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:10px 12px;
      text-align:center;
      cursor:pointer;
      font-weight:600;
    }
    .conv-list{
      overflow:auto;
      padding:6px 6px 80px; /* leave room above sticky footer */
      flex:1;
    }
    .conv-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 10px;
      margin:6px;
      border-radius:10px;
      cursor:pointer;
      position:relative;
    }
    .conv-item:hover{ background:var(--hover); }
    .conv-item.active{ background:#e9efff; }
    .conv-title{
      flex:1;
      font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .conv-title input{
      width:100%; border:1px solid var(--border); border-radius:6px; padding:4px 6px; font-size:13px;
    }
    .conv-item .more{
      visibility:hidden;
      border:0;
      background:transparent;
      cursor:pointer;
      padding:4px;
      border-radius:6px;
    }
    .conv-item:hover .more{ visibility:visible; }
    .menu{
      position:absolute;
      right:8px; top:36px;
      background:#fff; border:1px solid var(--border); border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      min-width:160px; z-index:20;
      display:none; overflow:hidden;
    }
    .menu.open{ display:block; }
    .menu button{
      width:100%; text-align:left; border:0; background:#fff; padding:10px 12px; cursor:pointer; font-size:14px;
    }
    .menu button:hover{ background:#f6f7fb; }
    .sidebar .bottom{
      position:sticky;
      bottom:0;
      background:linear-gradient(180deg, rgba(249,250,252,0), rgba(249,250,252,1) 35%);
      padding:10px 12px 12px;
      border-top:1px solid var(--border);
    }
    .userbox{
      display:flex; align-items:center; gap:8px; font-size:13px; color:#111827; padding:6px 8px; border-radius:8px; background:#fff; border:1px solid var(--border);
    }
    .signout{
      margin-top:8px;
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    .header{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:#fff;
    }
    .title{
      font-weight:700; font-size:15px;
    }
    .status{ color:var(--muted); font-size:12px; margin-left:auto; }
    .msgs{
      flex:1; overflow:auto; padding:18px 20px 8px;
    }
    .bubble{
      max-width:900px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      margin:10px 0;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .bubble.user{ background:#eef3ff; border-color:#dbe7ff; }
    .bubble.assistant{ background:#fff; }
    .meta{ color:var(--muted); font-size:12px; margin-top:2px; }
    .code{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#f7f7fb; border:1px solid var(--border); padding:8px; border-radius:8px; display:block; overflow:auto }
    .h2{ font-weight:700; font-size:16px; margin:8px 0 4px }
    .strong{ font-weight:700 }

    /* Export panel */
    .export-panel {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin: 6px 0 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
      max-width:900px;
    }
    .export-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .export-row button {
      border: 1px solid var(--border); background:#f8f9fa; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600;
    }
    .export-links { display:grid; gap:8px; }
    .export-item { display:flex; align-items:center; justify-content:space-between; gap:8px; background:#fafafa; border:1px solid var(--border); border-radius:8px; padding:8px 10px; }
    .export-item a { text-decoration:none; color:#0b57d0; word-break:break-all; }
    .pill { font-size:12px; padding:3px 8px; border-radius:999px; background:#eef3ff; color:#0b57d0; border:1px solid #cfe0ff;}
    .muted { color:#666; font-size:12px; }

    /* Composer */
    .composer{
      border-top:1px solid var(--border);
      background:#fff;
      padding:10px 14px;
    }
    .composer-inner{
      display:flex; gap:8px; align-items:flex-end; max-width:980px;
    }
    .composer textarea{
      flex:1;
      resize:none; min-height:48px; max-height:160px;
      border:1px solid var(--border); border-radius:12px; padding:12px 12px 12px 44px; outline:none;
      background:#fafafa;
      font-size:14px;
    }
    .icon-btn{
      position:absolute; margin-left:10px; margin-top:10px;
      background:transparent; border:0; cursor:pointer; font-size:18px; color:#374151;
    }
    .send{
      border:0; background:var(--primary); color:#fff; font-weight:700; padding:12px 16px; border-radius:12px; cursor:pointer;
    }
    .attach{ position:relative }
    .attach input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
    .chip{
      font-size:12px; border:1px solid var(--border); border-radius:999px; padding:4px 8px; color:#374151; background:#f5f7fb;
    }
    .hidden{ display:none !important; }
    .danger{ color:var(--danger) }
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="top">
      <div class="brand">GPTs Help</div>
      <div class="mode-switch">
        <button id="btnMath" class="active" title="Math GPT">Math</button>
        <button id="btnContent" title="ContentGPT">Content</button>
      </div>
    </div>
    <button class="new-chat" id="btnNewChat">+ New chat</button>
    <div id="convList" class="conv-list"></div>

    <div class="bottom">
      <div class="userbox">
        <div style="width:24px;height:24px;border-radius:999px;background:#e5e7eb;display:inline-flex;align-items:center;justify-content:center">ðŸ‘¤</div>
        <div id="userEmailLabel">Not signed in</div>
      </div>
      <button class="signout" id="btnSignOut">Sign out</button>
      <div style="margin-top:6px; display:flex; gap:6px">
        <button id="btnDebugLogin" class="chip" title="Mark subscribed (debug)">Debug login</button>
        <a class="chip" href="/index.html">Account</a>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="header">
      <div class="title" id="convTitle">New chat</div>
      <div class="status" id="status">Ready</div>
    </div>

    <!-- Export Panel (ContentGPT) -->
    <div id="exportPanel" class="export-panel hidden">
      <div class="export-row">
        <strong>Export Content</strong>
        <span id="exportStatus" class="muted"></span>
      </div>
      <div class="export-row">
        <button id="btnGenLinks">Generate Download Links</button>
        <button id="btnRegenLinks" class="hidden">Regenerate</button>
        <span class="muted">Links expire ~10 minutes after creation.</span>
      </div>
      <div id="exportLinks" class="export-links"></div>
    </div>

    <!-- Messages -->
    <div id="msgs" class="msgs"></div>

    <!-- Composer -->
    <div class="composer">
      <div class="composer-inner">
        <div class="attach">
          <button class="icon-btn" title="Attach an image for photo-solve (Math)">ðŸ“·</button>
          <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp" />
        </div>
        <div style="position:relative; flex:1">
          <button class="icon-btn" style="left:0">ðŸ’¬</button>
          <textarea id="prompt" placeholder="Send a messageâ€¦"></textarea>
        </div>
        <button id="btnSend" class="send">Send</button>
      </div>
      <div id="composerHint" class="muted" style="margin-top:6px">Tip: In Content mode, the message is treated as your topic or source text.</div>
    </div>
  </main>
</div>

<script>
/** ---------------------------
 * Global App State
 * --------------------------- */
const state = {
  userEmail: localStorage.getItem('userEmail') || '',
  subscribed: false,
  activeMode: localStorage.getItem('mode') || 'math', // 'math' | 'content'
  activeConversationId: null,
  conversations: [],
  config: {},
  lastContentPackage: null,
  lastExportLinks: [],
  exportCountdownTimer: null,
  exportFormatsAvailable: { md:true, html:true, docx:true, pdf:true, pptx:true },
};

const el = (id) => document.getElementById(id);

/** ---------------------------
 * Init
 * --------------------------- */
async function init() {
  // mode btns
  el('btnMath').addEventListener('click', () => setMode('math'));
  el('btnContent').addEventListener('click', () => setMode('content'));

  // buttons
  el('btnNewChat').addEventListener('click', onNewChat);
  el('btnSend').addEventListener('click', onSend);
  el('btnSignOut').addEventListener('click', signOut);
  el('btnDebugLogin').addEventListener('click', debugLogin);

  // Export panel buttons
  el('btnGenLinks').addEventListener('click', () => generateExportLinks(false));
  el('btnRegenLinks').addEventListener('click', () => generateExportLinks(true));

  // Enter-to-send
  el('prompt').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      onSend();
    }
  });

  // Choose file triggers photo-solve path automatically on next send
  el('fileInput').addEventListener('change', () => {
    if (el('fileInput').files?.length) {
      hint('Image attached. Send to solve with vision.');
    }
  });

  // Config
  try {
    const cfg = await (await fetch('/api/config')).json();
    state.config = cfg || {};
    if (cfg?.features?.exports) state.exportFormatsAvailable = cfg.features.exports;
  } catch {}

  // Identify user
  if (!state.userEmail) {
    const email = prompt('Enter your email to continue:');
    if (!email) {
      alert('Email required to use chat.');
      return;
    }
    state.userEmail = email.trim();
    localStorage.setItem('userEmail', state.userEmail);
  }
  el('userEmailLabel').textContent = state.userEmail;

  // Check subscription
  await refreshSubscription();

  // Conversations
  await refreshConversations();

  // Mode UI
  setMode(state.activeMode);

  // Open shared conversation via ?c=ID if provided
  const url = new URL(window.location.href);
  const cid = url.searchParams.get('c');
  if (cid) selectConversation(Number(cid));
}
window.addEventListener('load', init);

/** ---------------------------
 * Subscription helpers
 * --------------------------- */
async function refreshSubscription() {
  try {
    const r = await fetch(`/api/user/${encodeURIComponent(state.userEmail)}`);
    const j = await r.json();
    state.subscribed = !!j.subscribed;
    if (!state.subscribed) {
      setStatus('Not subscribed â€” use Account page or Debug login.');
    } else {
      setStatus('Ready');
    }
  } catch {
    setStatus('Unable to verify subscription');
  }
}
async function debugLogin() {
  if (!state.userEmail) return;
  await fetch('/api/debug-login', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ email: state.userEmail })
  });
  await refreshSubscription();
  await refreshConversations();
}

/** ---------------------------
 * Conversations
 * --------------------------- */
async function refreshConversations() {
  if (!state.userEmail) return;
  try {
    const r = await fetch(`/api/conversations?userId=${encodeURIComponent(state.userEmail)}`);
    if (!r.ok) throw new Error();
    state.conversations = await r.json();
    renderConvList();
  } catch {
    // silent
  }
}
function renderConvList() {
  const list = el('convList');
  list.innerHTML = '';
  state.conversations.forEach(c => {
    const item = document.createElement('div');
    item.className = 'conv-item' + (state.activeConversationId === c.id ? ' active' : '');
    item.dataset.id = c.id;

    const title = document.createElement('div');
    title.className = 'conv-title';
    title.textContent = c.title;

    const more = document.createElement('button');
    more.className = 'more';
    more.textContent = 'â‹¯';
    more.title = 'More';
    more.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleConvMenu(item, c);
    });

    item.appendChild(title);
    item.appendChild(more);

    // click to select
    item.addEventListener('click', () => selectConversation(c.id));
    list.appendChild(item);
  });
}
function toggleConvMenu(item, conv) {
  closeAllMenus();
  let menu = item.querySelector('.menu');
  if (!menu) {
    menu = document.createElement('div');
    menu.className = 'menu';
    const bShare = document.createElement('button');
    bShare.textContent = 'Share (copy link)';
    bShare.addEventListener('click', (e) => {
      e.stopPropagation();
      const url = `${location.origin}${location.pathname}?c=${conv.id}`;
      navigator.clipboard?.writeText(url);
      menu.classList.remove('open');
      hint('Share link copied');
    });
    const bRename = document.createElement('button');
    bRename.textContent = 'Rename';
    bRename.addEventListener('click', (e) => {
      e.stopPropagation();
      menu.classList.remove('open');
      beginInlineRename(item, conv);
    });
    const bDelete = document.createElement('button');
    bDelete.classList.add('danger');
    bDelete.textContent = 'Delete';
    bDelete.addEventListener('click', async (e) => {
      e.stopPropagation();
      menu.classList.remove('open');
      if (!confirm('Delete this conversation?')) return;
      await fetch(`/api/conversations/${conv.id}`, {
        method:'DELETE', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: state.userEmail })
      });
      if (state.activeConversationId === conv.id) {
        state.activeConversationId = null;
        el('msgs').innerHTML = '';
        el('convTitle').textContent = 'New chat';
      }
      await refreshConversations();
    });
    menu.appendChild(bShare);
    menu.appendChild(bRename);
    menu.appendChild(bDelete);
    item.appendChild(menu);
  }
  menu.classList.toggle('open');
  document.addEventListener('click', closeAllMenus, { once:true });
}
function closeAllMenus(){ document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open')); }

function beginInlineRename(item, conv) {
  const title = item.querySelector('.conv-title');
  const old = title.textContent;
  title.innerHTML = '';
  const input = document.createElement('input');
  input.value = old;
  title.appendChild(input);
  input.focus();
  input.select();
  const commit = async () => {
    const val = input.value.trim();
    if (!val) { title.textContent = old; return; }
    await fetch(`/api/conversations/${conv.id}`, {
      method:'PATCH', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId: state.userEmail, title: val })
    });
    title.textContent = val;
    const idx = state.conversations.findIndex(c => c.id === conv.id);
    if (idx >= 0) state.conversations[idx].title = val;
    if (state.activeConversationId === conv.id) el('convTitle').textContent = val;
  };
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') commit();
    else if (e.key === 'Escape') title.textContent = old;
  });
  input.addEventListener('blur', commit);
}

async function selectConversation(id) {
  state.activeConversationId = id;
  const conv = state.conversations.find(c => c.id === id);
  el('convTitle').textContent = conv?.title || 'Conversation';
  renderConvList();
  await loadMessages(id);
}
async function onNewChat() {
  if (!state.userEmail) return;
  const r = await fetch('/api/conversations', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ userId: state.userEmail, title: 'New chat' })
  });
  const c = await r.json();
  await refreshConversations();
  await selectConversation(c.id);
}

/** ---------------------------
 * Messages
 * --------------------------- */
async function loadMessages(convId) {
  try {
    const r = await fetch(`/api/conversations/${convId}?userId=${encodeURIComponent(state.userEmail)}`);
    const j = await r.json();
    const msgs = j.messages || [];
    const box = el('msgs');
    box.innerHTML = '';
    msgs.forEach(m => {
      appendBubble(m.role, m.content);
    });
    box.scrollTop = box.scrollHeight;
  } catch {}
}
function appendBubble(role, content) {
  const b = document.createElement('div');
  b.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
  b.innerHTML = renderText(content);
  el('msgs').appendChild(b);
  el('msgs').scrollTop = el('msgs').scrollHeight;
}

/** Basic renderer to hide raw markdown markers like ## and ** */
function renderText(t='') {
  // Escape basic HTML
  let s = String(t)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // Headings (## ...)
  s = s.replace(/^\s*#{1,3}\s+(.*)$/gm, (_,p1)=> `<div class="h2">${p1}</div>`);
  // Bold **...**
  s = s.replace(/\*\*(.+?)\*\*/g, '<span class="strong">$1</span>');
  // Inline code `...`
  s = s.replace(/`([^`]+?)`/g, '<code class="code">$1</code>');
  // Lists
  s = s.replace(/^\s*-\s+(.*)$/gm, 'â€¢ $1');
  // Horizontal rule-like lines
  s = s.replace(/^\s*---\s*$/gm, '');

  // Newlines
  return s;
}

/** ---------------------------
 * Sending
 * --------------------------- */
async function onSend() {
  if (!state.subscribed) { alert('You are not subscribed. Use Account or Debug login.'); return; }

  const text = el('prompt').value.trim();
  const file = el('fileInput').files?.[0] || null;

  if (!text && !file) return;

  appendBubble('user', (file ? 'ðŸ“· ' : '') + text);
  el('prompt').value = '';
  setStatus('Thinkingâ€¦');

  try {
    if (state.activeMode === 'content') {
      await sendContent(text);
    } else if (file) {
      await sendPhoto(text, file);
      el('fileInput').value = '';
    } else {
      await sendMath(text);
    }
  } catch (e) {
    appendBubble('assistant', 'Sorryâ€”something went wrong.');
  } finally {
    setStatus('Ready');
    await refreshConversations(); // pick up auto-title changes
  }
}

async function ensureConversation() {
  if (state.activeConversationId) return state.activeConversationId;
  await onNewChat();
  return state.activeConversationId;
}

async function sendMath(message) {
  const conversationId = await ensureConversation();
  const r = await fetch('/api/chat', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      message, gptType: 'math', userId: state.userEmail, conversationId
    })
  });
  const j = await r.json();
  if (!r.ok) throw new Error(j.error || 'chat failed');
  appendBubble('assistant', j.response);
  state.activeConversationId = j.conversationId || state.activeConversationId;
}

async function sendPhoto(attempt, file) {
  const conversationId = await ensureConversation();
  const fd = new FormData();
  fd.append('userId', state.userEmail);
  fd.append('gptType', 'math');
  fd.append('attempt', attempt || '');
  fd.append('conversationId', conversationId);
  fd.append('image', file);
  const r = await fetch('/api/photo-solve', { method:'POST', body: fd });
  const j = await r.json();
  if (!r.ok) throw new Error(j.error || 'photo-solve failed');
  appendBubble('assistant', j.response);
  state.activeConversationId = j.conversationId || state.activeConversationId;
}

async function sendContent(sourceOrTopic) {
  // In Content mode, a plain message is treated as your source/topic.
  const conversationId = await ensureConversation();
  const r = await fetch('/api/content/multiformat', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      userId: state.userEmail,
      source: sourceOrTopic,
      topic: sourceOrTopic,
      audience: '',
      tone: 'professional',
      goal: 'awareness',
      keywords: [],
      length: 'medium',
      conversationId
    })
  });
  const j = await r.json();
  if (!r.ok) throw new Error(j.error || 'content failed');

  // Save package for export links
  onContentGPTSuccess(j);

  // Show a friendly summary message
  const title = j?.content?.title || 'Content Package';
  const msg = `Content generated: ${title}
Formats: Blog â€¢ LinkedIn â€¢ X Thread â€¢ Newsletter â€¢ YouTube â€¢ TikTok
Use the Export panel above to download.`;
  appendBubble('assistant', msg);

  state.activeConversationId = j.conversationId || state.activeConversationId;
}

/** ---------------------------
 * Mode & UI helpers
 * --------------------------- */
function setMode(mode){
  state.activeMode = mode;
  localStorage.setItem('mode', mode);
  el('btnMath').classList.toggle('active', mode==='math');
  el('btnContent').classList.toggle('active', mode==='content');
  el('composerHint').textContent =
    mode==='content'
      ? 'Tip: In Content mode, your message is treated as the topic/source. We will generate multi-format content.'
      : 'Tip: Attach an image to solve photo-based problems.';
  // Hide export panel unless last content exists
  if (mode==='content' && state.lastContentPackage) {
    el('exportPanel').classList.remove('hidden');
  } else {
    el('exportPanel').classList.add('hidden');
  }
}
function setStatus(t){ el('status').textContent = t; }
function hint(t){ setStatus(t); setTimeout(()=> setStatus('Ready'), 1500); }
function signOut(){
  localStorage.removeItem('userEmail');
  location.href = '/index.html';
}

/** ---------------------------
 * Export links (ContentGPT)
 * --------------------------- */
function onContentGPTSuccess(payload){
  state.lastContentPackage = payload.content;
  el('exportPanel').classList.remove('hidden');
  el('btnGenLinks').classList.remove('hidden');
  el('btnRegenLinks').classList.add('hidden');
  el('exportLinks').innerHTML = '';
  el('exportStatus').textContent = '';
}

function defaultExportItems(){
  const out = [];
  const caps = state.exportFormatsAvailable || {};
  if (caps.md) out.push({format:'md', which:'all'});
  if (caps.html) out.push({format:'html', which:'all'});
  if (caps.docx) out.push({format:'docx', which:'all'});
  if (caps.pdf) out.push({format:'pdf', which:'all'});
  if (caps.pptx) out.push({format:'pptx', which:'all'});
  return out;
}

async function generateExportLinks(regen){
  if (!state.lastContentPackage) {
    alert('No content to export. Generate with Content mode first.');
    return;
  }
  setExportBusy(true, regen ? 'Regenerating linksâ€¦' : 'Generating linksâ€¦');
  try {
    const body = {
      userId: state.userEmail,
      content: state.lastContentPackage,
      items: defaultExportItems(),
      ttlSec: 10*60
    };
    const r = await fetch('/api/content/export-links', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j?.detail || j?.error || 'failed');
    state.lastExportLinks = (j.links || []).filter(x => x.url);
    renderExportLinks(state.lastExportLinks);
    el('btnGenLinks').classList.add('hidden');
    el('btnRegenLinks').classList.remove('hidden');
    setExportBusy(false, `Ready. ${state.lastExportLinks.length} link(s) generated.`);
  } catch (e) {
    setExportBusy(false, 'Error generating links');
    alert('Export error: ' + e.message);
  }
}

function renderExportLinks(links){
  const box = el('exportLinks');
  box.innerHTML = '';
  if (state.exportCountdownTimer) { clearInterval(state.exportCountdownTimer); state.exportCountdownTimer = null; }

  const now = Date.now();
  links.forEach((ln, i) => {
    const row = document.createElement('div');
    row.className = 'export-item';

    const left = document.createElement('div');
    const title = document.createElement('div');
    title.innerHTML = `<a href="${ln.url}" target="_blank" rel="noopener">${ln.filename || (ln.format.toUpperCase() + ' download')}</a>`;
    const meta = document.createElement('div');
    meta.className = 'muted';
    meta.dataset.expiresAt = ln.expiresAt;
    const secsLeft = Math.max(0, Math.floor((ln.expiresAt - now)/1000));
    meta.textContent = 'Expires in ' + fmtCountdown(secsLeft);
    left.appendChild(title);
    left.appendChild(meta);

    const right = document.createElement('div');
    const tag = document.createElement('span');
    tag.className = 'pill';
    tag.textContent = `${(ln.which||'all')} â€¢ ${ln.format.toUpperCase()}`;
    const copyBtn = document.createElement('button');
    copyBtn.textContent = 'Copy Link';
    copyBtn.addEventListener('click', () => copyToClipboard(ln.url));
    right.appendChild(tag);
    right.appendChild(copyBtn);

    row.appendChild(left); row.appendChild(right);
    box.appendChild(row);
  });

  // countdown updates
  state.exportCountdownTimer = setInterval(() => {
    const metas = box.querySelectorAll('.muted');
    const t = Date.now();
    metas.forEach(elm => {
      const exp = Number(elm.dataset.expiresAt);
      const secs = Math.max(0, Math.floor((exp - t)/1000));
      elm.textContent = secs>0 ? ('Expires in ' + fmtCountdown(secs)) : 'Link expired';
    });
    if (links.every(ln => ln.expiresAt <= Date.now())) {
      clearInterval(state.exportCountdownTimer);
      state.exportCountdownTimer = null;
    }
  }, 1000);
}

function setExportBusy(busy, text){
  el('exportStatus').textContent = text || '';
  el('btnGenLinks').disabled = busy;
  el('btnRegenLinks').disabled = busy;
}
function fmtCountdown(total){
  const m = Math.floor(total/60); const s = total%60;
  return m>0 ? `${m}m ${String(s).padStart(2,'0')}s` : `${s}s`;
}
function copyToClipboard(text){
  navigator.clipboard?.writeText(text).then(
    ()=> setExportBusy(false, 'Link copied'),
    ()=> alert(text)
  );
}
</script>
</body>
</html>
